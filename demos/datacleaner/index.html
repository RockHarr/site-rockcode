<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DataCleaner · RockCode</title>
<meta name="description" content="DataCleaner: limpia CSV/Excel en segundos. Quita duplicados, normaliza fechas y valida RUT.">
<link rel="icon" href="/assets/img/favicon.png" />
<style>
  :root{
    --bg:#0b1220;--panel:#0f172a;--ink:#e5e7eb;--muted:#94a3b8;
    --line:#1f2937;--accent:#22c55e;--accent-ink:#052814;--danger:#ef4444
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0a0f1f,#0b1220);color:var(--ink);
    font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif}
  .wrap{max-width:1200px;margin:0 auto;padding:24px}
  h1{font-size:clamp(22px,4vw,32px);margin:0 0 8px}
  .sub{color:var(--muted);margin:0 0 16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  label{display:block;font-weight:600;margin:0 0 8px;color:var(--muted)}
  textarea{width:100%;min-height:170px;background:#0b1220;border:1px solid var(--line);
    border-radius:12px;color:var(--ink);padding:12px;resize:vertical}
  .btn{appearance:none;border:1px solid var(--line);background:#0f172a;color:var(--ink);
    padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn.primary{background:var(--accent);border-color:#16a34a;color:var(--accent-ink)}
  .btn.ghost{background:transparent}
  .btn.danger{background:#1a0b0b;border-color:#7f1d1d;color:#fecaca}
  .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px}
  .table-wrap{margin-top:14px;border:1px solid var(--line);border-radius:12px;overflow:auto}
  table{border-collapse:collapse;width:100%;background:rgba(255,255,255,.02);font-size:13px;white-space:nowrap}
  th{position:sticky;top:0;background:#111827;color:#9ca3af;font-weight:600}
  td,th{border:1px solid #1f2937;padding:6px 8px;text-align:left}
  tbody tr:nth-child(even){background:rgba(255,255,255,.03)}
  .footer{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-top:16px;color:var(--muted)}
  .hint{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <main class="wrap">
    <h1>DataCleaner</h1>
    <p class="sub">Limpia datos en segundos: CSV/Excel, fechas, duplicados, RUT. Diseñado por RockCode.</p>

    <div class="card">
      <div class="grid">
        <section>
          <label for="raw">Pega tus datos (CSV con coma o punto y coma)</label>
          <textarea id="raw" spellcheck="false"></textarea>
          <div class="bar" style="margin-top:10px">
            <button class="btn primary" id="load">Cargar</button>
            <button class="btn ghost" id="clear">Limpiar</button>
            <span class="pill" id="meta">0 filas · 0 columnas</span>
          </div>
        </section>

        <section>
          <label>Acciones</label>
          <div class="bar" style="margin-top:2px">
            <button class="btn" data-act="trim">Quitar espacios</button>
            <button class="btn" data-act="collapse">Espacios múltiples → uno</button>
            <button class="btn" data-act="lower">minúsculas</button>
            <button class="btn" data-act="upper">MAYÚSCULAS</button>
            <button class="btn" data-act="title">Título</button>
            <button class="btn" data-act="dedupe">Eliminar duplicados</button>
            <button class="btn" data-act="drop-empty">Eliminar filas vacías</button>
            <button class="btn" data-act="normalize">Quitar acentos</button>
            <button class="btn" data-act="date">Normalizar fecha</button>
            <button class="btn" data-act="rut-normalize">Normalizar RUT</button>
            <button class="btn" data-act="rut-validate">Validar RUT</button>
            <button class="btn" data-act="rut-duplicates">Etiquetar duplicados RUT</button>
          </div>
        </section>
      </div>

      <div class="table-wrap">
        <table id="table" aria-live="polite"></table>
      </div>

      <div class="bar" style="margin-top:12px">
        <button class="btn ghost" id="copyCsv">Copiar CSV</button>
        <button class="btn ghost" id="downloadCsv">Descargar CSV (ordenado)</button>
        <button class="btn" id="downloadXls">Descargar Excel (XLS)</button>
        <button class="btn primary" id="downloadXlsx">Descargar Excel (XLSX)</button>
        <span class="hint">* XLSX requiere <code>xlsx.full.min.js</code> en esta carpeta.</span>
      </div>
    </div>

    <div class="footer">
      <div>© <span id="y"></span> RockCode — DataCleaner.</div>
      <div class="hint">Diseño & desarrollo: <strong>Rockwell Harrison</strong> + <strong>Spark (ChatGPT)</strong></div>
    </div>
  </main>

  <!-- XLSX opcional / mismo directorio -->
  <script src="xlsx.full.min.js"></script>
  <script>
  (function(){
    const $ = id => document.getElementById(id);
    const meta = $('meta'), tableEl = $('table');

    // Estado
    let data = []; // AOA: [ [headers], [row], ... ]

    // Utilidades ---------------------

    // Quitar BOM y normalizar saltos
    function cleanText(t){
      return String(t || '')
        .replace(/^\uFEFF/, '')      // BOM
        .replace(/\r\n/g, '\n')      // Windows -> LF
        .replace(/\r/g, '\n');       // Mac -> LF
    }

    // Parser CSV robusto con autodetección de separador y comillas
    function parseCSV(text){
      const src = cleanText(text);
      if (!src.trim()) return [];

      // Autodetección del separador en primeras líneas
      const sample = src.split('\n').slice(0, 5).join('\n');
      const commas  = (sample.match(/,/g) || []).length;
      const semis   = (sample.match(/;/g) || []).length;
      const sep = semis > commas ? ';' : ',';

      const lines = src.split('\n');
      const out = [];
      for (let line of lines){
        // Permite líneas vacías (se filtrarán después si se pide)
        let row = [];
        let cur = '';
        let inQ = false;

        for (let i = 0; i < line.length; i++){
          const ch = line[i], nx = line[i+1];

          if (ch === '"'){                 // comillas
            if (inQ && nx === '"'){        // escape ""
              cur += '"'; i++;
            } else {
              inQ = !inQ;
            }
          } else if (ch === sep && !inQ){  // separador fuera de comillas
            row.push(cur);
            cur = '';
          } else {
            cur += ch;
          }
        }
        row.push(cur);

        // No trims destructivos aquí; se hace en acciones
        out.push(row);
      }
      // No eliminar vacíos; dejar que "Eliminar filas vacías" lo haga
      return out;
    }

    function toCSV(rows, sep=','){
      return rows.map(r => r.map(c => {
        const s = String(c ?? '');
        return /["\n,;\t]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
      }).join(sep)).join('\n');
    }

    function stripDiacritics(s){
      // Solo elimina marcas combinantes. No borra letras ni números.
      return String(s ?? '').normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    function toTitleCase(s){
      return String(s || '').toLowerCase()
        .replace(/\b([\p{L}\p{M}][\p{L}\p{M}'-]*)/gu, m => m[0].toUpperCase() + m.slice(1));
    }

    function render(){
      tableEl.innerHTML = '';
      if (!data.length){ meta.textContent = '0 filas · 0 columnas'; return; }

      const cols = Math.max(...data.map(r => r.length));
      const header = data[0] || [];
      let thead = '<thead><tr>';
      for (let i=0;i<cols;i++) thead += `<th>${(header[i] ?? ('Col ' + (i+1)))}</th>`;
      thead += '</tr></thead>';

      let tbody = '<tbody>';
      for (let r=1; r<data.length; r++){
        const row = data[r] || [];
        tbody += '<tr>';
        for (let c=0; c<cols; c++) tbody += `<td>${(row[c] ?? '')}</td>`;
        tbody += '</tr>';
      }
      tbody += '</tbody>';

      tableEl.innerHTML = thead + tbody;
      meta.textContent = `${Math.max(0, data.length-1)} filas · ${cols} columnas`;
    }

    // Acciones -----------------------

    const actions = {
      trim(){
        for (let r=1;r<data.length;r++){
          data[r] = (data[r] || []).map(c => String(c ?? '').trim());
        }
      },
      collapse(){
        for (let r=1;r<data.length;r++){
          data[r] = (data[r] || []).map(c => String(c ?? '').replace(/\s+/g, ' ').trim());
        }
      },
      lower(){
        for (let r=1;r<data.length;r++){
          data[r] = (data[r] || []).map(c => String(c ?? '').toLowerCase());
        }
      },
      upper(){
        for (let r=1;r<data.length;r++){
          data[r] = (data[r] || []).map(c => String(c ?? '').toUpperCase());
        }
      },
      title(){
        for (let r=1;r<data.length;r++){
          data[r] = (data[r] || []).map(c => toTitleCase(c));
        }
      },
      dedupe(){
        const seen = new Set();
        const out = [data[0]];
        for (let r=1; r<data.length; r++){
          const key = JSON.stringify(data[r] || []);
          if (!seen.has(key)){ seen.add(key); out.push(data[r]); }
        }
        data = out;
      },
      'drop-empty'(){
        data = [data[0], ...data.slice(1).filter(row => (row||[]).some(c => String(c||'').trim() !== ''))];
      },
      normalize(){
        for (let r=1;r<data.length;r++){
          data[r] = (data[r] || []).map(c => stripDiacritics(c));
        }
      },
      date(){
        // Heurística dd/mm primero si ambiguo
        const norm = s => {
          const t = String(s || '').trim();
          // 1)  dd/mm/yy(yy)  o  dd-mm-yy(yy)
          let m = t.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
          if (m){
            let d = +m[1], M = +m[2], Y = +m[3];
            if (Y < 100) Y += 2000;
            // si ambiguo (ambos <=12), asumir dd/mm
            if (d <=12 && M <=12){
              // ya d/M
            } else if (M > 12 && d <= 12){ // mm/dd -> dd/mm
              [d, M] = [M, d];
            }
            return `${Y}-${String(M).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          }
          // 2)  yyyy-mm-dd
          m = t.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
          if (m){
            const Y = +m[1], M = +m[2], d = +m[3];
            return `${Y}-${String(M).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          }
          // 3)  mm/dd/yyyy o mm-dd-yyyy -> pasarlo a ISO asumiendo formato US
          m = t.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
          if (m && (+m[1] <= 12 && +m[2] <=31)){
            const M = +m[1], d = +m[2], Y = +m[3];
            return `${Y}-${String(M).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          }
          return s; // dejar como está
        };
        for (let r=1;r<data.length;r++){
          data[r] = (data[r] || []).map(c => norm(c));
        }
      },

      // ----- RUT -----
      _rut_detect(headers, sampleRow){
        let idx = (headers || []).findIndex(h => /rut/i.test(String(h||'')));
        if (idx < 0 && sampleRow){
          for (let c=0;c<sampleRow.length;c++){
            const v = String(sampleRow[c] || '');
            if (/[0-9Kk\.\-]{7,12}/.test(v)){ idx = c; break; }
          }
        }
        return idx < 0 ? 0 : idx;
      },
      _rut_clean(s){ return String(s||'').toUpperCase().replace(/[^0-9K]/g,''); },
      _rut_calcDV(body){
        let sum=0, mul=2;
        for (let i=body.length-1;i>=0;i--){
          sum += mul * (+body[i]);
          mul = mul === 7 ? 2 : mul+1;
        }
        const res = 11 - (sum % 11);
        return res === 11 ? '0' : (res === 10 ? 'K' : String(res));
      },
      _rut_format(body,dv){ return body.replace(/\B(?=(\d{3})+(?!\d))/g,'.') + '-' + dv; },

      'rut-normalize'(){
        if (!data.length) return;
        const headers = data[0] || [];
        const idx = this._rut_detect(headers, data[1]);
        const out = data.map((row,i) => {
          if (i === 0) return row;
          const raw = String((row||[])[idx] || '').trim();
          if (!raw) return row;
          const cleaned = this._rut_clean(raw);
          if (cleaned.length < 2) return row;
          const body = cleaned.slice(0,-1);
          const dv   = cleaned.slice(-1);
          const ok   = this._rut_calcDV(body) === dv;
          const copy = (row||[]).slice();
          copy[idx]  = this._rut_format(body,dv) + (ok ? '' : ' ⚠️');
          return copy;
        });
        data = out;
      },

      'rut-validate'(){
        if (!data.length) return;
        let headers = (data[0] || []).slice();
        let col = headers.findIndex(h => /RUT_Valido/i.test(String(h||'')));
        if (col < 0){ col = headers.length; headers.push('RUT_Valido'); }
        const idx = this._rut_detect(data[0], data[1]);
        const out = [headers].concat(data.slice(1).map(row => {
          const r = (row||[]).slice();
          const cleaned = this._rut_clean(r[idx]);
          let ok = false;
          if (cleaned.length >= 2){
            const body = cleaned.slice(0,-1);
            const dv   = cleaned.slice(-1);
            ok = this._rut_calcDV(body) === dv;
          }
          r[col] = ok ? 'Sí' : 'No';
          return r;
        }));
        data = out;
      },

      'rut-duplicates'(){
        if (!data.length) return;
        let headers = (data[0] || []).slice();
        let col = headers.findIndex(h => /RUT_Duplicado/i.test(String(h||'')));
        if (col < 0){ col = headers.length; headers.push('RUT_Duplicado'); }
        const idx = this._rut_detect(data[0], data[1]);
        const counts = new Map();
        data.slice(1).forEach(r => {
          const k = this._rut_clean((r||[])[idx] || '');
          if (!k) return;
          counts.set(k, (counts.get(k) || 0) + 1);
        });
        const out = [headers].concat(data.slice(1).map(row => {
          const r = (row||[]).slice();
          const key = this._rut_clean(r[idx] || '');
          r[col] = key && counts.get(key) > 1 ? 'Sí' : 'No';
          return r;
        }));
        data = out;
      }
    };

    // Acciones → render
    document.querySelectorAll('[data-act]').forEach(btn => {
      btn.addEventListener('click', () => {
        const act = btn.getAttribute('data-act');
        if (actions[act]){ actions[act](); render(); }
      });
    });

    // Cargar
    $('load').addEventListener('click', () => {
      const src = $('raw').value;
      const rows = parseCSV(src);
      if (!rows.length){ data = []; render(); return; }
      // Si la primera fila parece ser cabecera (tiene letras, no solo números), úsala
      const head = rows[0] || [];
      const scoreLetters = head.filter(x => /[A-Za-zÁÉÍÓÚÜÑáéíóúüñ]/.test(String(x||''))).length;
      data = scoreLetters ? rows : [['Col 1','Col 2','Col 3','Col 4','Col 5'].slice(0,(rows[0]||[]).length), ...rows];
      render();
    });

    // Limpiar
    $('clear').addEventListener('click', () => { $('raw').value=''; data=[]; render(); });

    // Copiar con fallback
    async function copyTextSafe(text){
      try{
        await navigator.clipboard.writeText(text);
      }catch(e){
        const ta=document.createElement('textarea');
        ta.value=text; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy');
        ta.remove();
      }
    }

    $('copyCsv').addEventListener('click', async function(){
      if (!data.length) return;
      const headers = (data[0]||[]).map(h => toTitleCase(String(h||'').replace(/_/g,' ')));
      const body = data.slice(1).filter(r => (r||[]).some(c => String(c||'').trim() !== ''));
      await copyTextSafe(toCSV([headers, ...body]));
      const t=this.textContent; this.textContent='¡Copiado!'; setTimeout(()=>this.textContent=t,1200);
    });

    $('downloadCsv').addEventListener('click', () => {
      if (!data.length) return;
      const headers = (data[0]||[]).map(h => toTitleCase(String(h||'').replace(/_/g,' ')));
      const body = data.slice(1).filter(r => (r||[]).some(c => String(c||'').trim() !== ''));
      const csv = toCSV([headers, ...body]);
      const blob = new Blob(['\ufeff'+csv], {type:'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='rockcode_datacleaner.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    // XLS (HTML compatible) – fallback universal
    $('downloadXls').addEventListener('click', () => {
      if (!data.length) return;
      const headers = (data[0]||[]).map(h => String(h||'').trim().replace(/_/g,' '));
      const body = data.slice(1).filter(r => (r||[]).some(c => String(c||'').trim() !== ''));
      const rows = [headers, ...body];
      const html = '<table border="1">' + rows.map((r,i)=>'<tr>' + r.map(c => {
        const cell = String(c ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;');
        return i===0 ? `<th>${cell}</th>` : `<td>${cell}</td>`;
      }).join('') + '</tr>').join('') + '</table>';
      const blob = new Blob([`<html><meta charset="utf-8">${html}</html>`], {type:'application/vnd.ms-excel'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='rockcode_datacleaner.xls'; a.click();
      URL.revokeObjectURL(url);
    });

    // XLSX nativo (si está la lib)
    $('downloadXlsx').addEventListener('click', () => {
      if (!window.XLSX){ alert('Para XLSX, coloca xlsx.full.min.js junto a este archivo.'); return; }
      if (!data.length) return;

      const headersRaw = data[0] || [];
      const headers = headersRaw.map(h => String(h||'').trim().replace(/_/g,' '));
      const body = data.slice(1).filter(r => (r||[]).some(c => String(c||'').trim() !== ''));

      const isNumericHeader = name =>
        /(edad|monto|total|tiempo|id|cantidad|nro|número|precio|anio|año)/i.test(name||'') &&
        !/rut/i.test(name||'');

      const rows = [headers, ...body.map(row => (row||[]).map((v,i) => {
        const s = String(v ?? '').trim();
        // ISO -> Date
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s + 'T00:00:00');
        // Num seguro (NO en columnas RUT)
        if (isNumericHeader(headers[i])){
          const n = Number(s.replace(/\./g,'').replace(',', '.'));
          if (!Number.isNaN(n) && isFinite(n)) return n;
        }
        return v;
      }))];

      const ws = XLSX.utils.aoa_to_sheet(rows, { cellDates:true });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'DataCleaner');

      // Autoancho + encabezado fijo + autofiltro
      const range = XLSX.utils.decode_range(ws['!ref']);
      ws['!cols'] = headers.map((h,c) => {
        let max = String(h||'').length;
        for (let r=1; r<=range.e.r; r++){
          const L = String(rows[r]?.[c] ?? '').length;
          if (L > max) max = L;
        }
        return { wch: Math.min(Math.max(10, max+2), 48) };
      });
      ws['!freeze'] = { xSplit:0, ySplit:1 };
      ws['!autofilter'] = { ref: ws['!ref'] };

      XLSX.writeFile(wb, 'rockcode_datacleaner.xlsx');
    });

    // Demo inicial (muestra que no pega todo en 1 línea)
    const demo = `nombre,correo,rut,fecha,ciudad
ANA, ana@example.com, 12345678-5, 1/2/24, ViÑA del Mar
Ana, ana@example.com, 12.345.678-5, 01-02-2024, viña  del   mar
Pedro, pedro@example.com, 11111111-1, 12/31/2023, santiago
,,,
JUAN, juan@example.com, 9876543k, 5-7-2024, PROVIDENCIA`;
    $('raw').value = demo;

    $('y').textContent = new Date().getFullYear();
    render();
  })();
  </script>
</body>
</html>
