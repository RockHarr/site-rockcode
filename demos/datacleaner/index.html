<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DataCleaner — RockCode</title>
<meta name="description" content="Limpia y valida datos CSV/Excel en segundos: RUT, fechas, tildes, duplicados y más.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b1220; --ink:#e5e7eb; --muted:#94a3b8; --line:#1f2937;
    --accent:#22c55e; --btn:#101827; --chip:#111827; --warn:#f59e0b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,sans-serif;background:linear-gradient(180deg,#0a0f1f,#0b1220);color:var(--ink)}
  .wrap{max-width:1200px;margin:0 auto;padding:20px 16px}
  h1{font-size:clamp(22px,3.6vw,32px);margin:0 0 10px}
  p.lead{color:var(--muted);margin:0 0 18px}
  .grid{display:grid;gap:16px;grid-template-columns:1.2fr 1fr}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.02)}
  .hd{padding:12px 14px;border-bottom:1px dashed var(--line);font-weight:600}
  .bd{padding:14px}
  textarea,input[type=file]{width:100%;border:1px solid var(--line);border-radius:12px;background:#0b1220;color:var(--ink);padding:10px;resize:vertical}
  textarea{min-height:160px}
  .btn{appearance:none;border:1px solid var(--line);background:var(--btn);color:var(--ink);padding:10px 14px;border-radius:14px;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--accent);color:#062b14;border-color:#16a34a}
  .btn.warn{background:#1f2937;border-color:#334155;color:#fde68a}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .chip{border:1px solid var(--line);background:var(--chip);padding:8px 12px;border-radius:12px;cursor:pointer}
  .meta{color:var(--muted);font-size:12px}
  .table-wrap{margin-top:12px;border:1px solid var(--line);border-radius:12px;overflow:auto;max-height:58vh}
  table{border-collapse:collapse;width:100%;font-size:13px;background:rgba(255,255,255,.02)}
  th,td{border:1px solid #1f2937;padding:6px 8px;white-space:nowrap;text-align:left}
  thead th{position:sticky;top:0;background:#0f172a;color:#9ca3af;font-weight:600;z-index:1}
  tbody tr:nth-child(even){background:rgba(255,255,255,.03)}
  .dz{display:flex;flex-direction:column;gap:8px;border:1px dashed #334155;padding:12px;border-radius:12px;background:#0b1220}
  .dz.is-drop{outline:3px solid #3b82f6;outline-offset:2px}
  footer{margin-top:16px;color:var(--muted);font-size:13px}
  .sr-only{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}
  .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px}
</style>
<!-- SheetJS para XLSX -->
<script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<main class="wrap">
  <h1>DataCleaner</h1>
  <p class="lead">Limpia datos en segundos: CSV/Excel, RUT, fechas, tildes, duplicados y más. Arrastra archivos o pega texto. <span class="pill">Ctrl+Enter = Cargar • Ctrl+K = Foco textarea</span></p>

  <section class="card" aria-labelledby="hd-in">
    <div class="hd" id="hd-in">Entrada</div>
    <div class="bd grid">
      <div>
        <label for="raw" class="meta">Pega tus datos (CSV separador coma o punto y coma)</label>
        <textarea id="raw" spellcheck="false" aria-describedby="hint-sep"></textarea>
        <div id="hint-sep" class="meta" style="margin-top:6px">Detectamos ; o , automáticamente. Si no hay cabeceras, creamos <em>Col 1..N</em>. Si las hay, las titulamos y mapeamos sinónimos (Nombre/Correo/RUT/Fecha/Ciudad/Monto).</div>
        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="load">Cargar</button>
          <button class="btn" id="clear">Limpiar</button>
          <button class="btn warn" id="demo">Cargar demo</button>
          <span class="chip" id="stats">0 filas · 0 columnas</span>
        </div>
      </div>
      <div>
        <div class="dz" id="drop">
          <strong>Arrastra aquí un archivo CSV / XLS / XLSX</strong>
          <input id="file" type="file" accept=".csv,.xls,.xlsx" />
          <span class="meta">O haz click para elegir archivo.</span>
        </div>
        <div style="margin-top:12px">
          <div class="meta" style="margin-bottom:6px">Acciones frecuentes</div>
          <div class="row">
            <button class="chip" data-act="trim">Quitar espacios</button>
            <button class="chip" data-act="collapse">Espacios múltiples → uno</button>
            <button class="chip" data-act="upper">MAYÚSCULAS</button>
            <button class="chip" data-act="lower">minúsculas</button>
            <button class="chip" data-act="title">Título</button>
            <button class="chip" data-act="normalize">Quitar acentos</button>
            <button class="chip" data-act="date">Normalizar fecha</button>
            <button class="chip" data-act="dedupe">Eliminar duplicados</button>
            <button class="chip" data-act="drop-empty">Quitar filas vacías</button>
          </div>
          <div class="meta" style="margin:12px 0 6px">RUT</div>
          <div class="row">
            <button class="chip" data-act="rut-normalize">RUT → formato</button>
            <button class="chip" data-act="rut-validate">Validar RUT</button>
            <button class="chip" data-act="rut-duplicates">Etiquetar duplicados RUT</button>
            <button class="chip" id="keep-valid">Mantener RUT válidos</button>
            <button class="chip" id="dedupe-by-rut">Quitar duplicados por RUT</button>
            <button class="chip" id="only-dupes">Solo duplicados por RUT</button>
          </div>
          <div class="meta" style="margin:12px 0 6px">Estado</div>
          <div class="row">
            <button class="chip" id="save-state" title="Guarda el AOA en LocalStorage">Guardar estado</button>
            <button class="chip" id="restore-state" title="Restaura el AOA guardado">Restaurar estado</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="card" style="margin-top:16px" aria-labelledby="hd-data">
    <div class="hd" id="hd-data">Datos</div>
    <div class="bd">
      <div class="table-wrap" role="region" aria-live="polite" aria-label="Tabla de resultados">
        <table id="table">
          <thead></thead><tbody></tbody>
        </table>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="copyCsv">Copiar CSV</button>
        <button class="btn" id="downloadCsv">Descargar CSV (ordenado)</button>
        <button class="btn primary" id="downloadXls">Descargar Excel (XLS)</button>
        <button class="btn" id="downloadXlsx">Descargar Excel (XLSX)</button>
      </div>
      <p class="meta" style="margin-top:6px">“Ordenado” = limpia filas vacías, titula cabeceras y mantiene solo filas con datos.</p>
    </div>
  </section>

  <footer>© 2025 RockCode — DataCleaner. Diseño & desarrollo: <strong>Rockwell Harrison</strong> + <strong>Spark (ChatGPT)</strong></footer>
</main>

<script>
(function(){
  // ======= Utils =======
  const $ = (q, el=document) => el.querySelector(q);
  const $$ = (q, el=document) => [...el.querySelectorAll(q)];
  const TA = $("#raw");
  const elStats = $("#stats");
  const elThead = $("#table thead");
  const elTbody = $("#table tbody");
  let data = []; // AOA: [headers, ...rows]

  // Helpers
  function toTitle(s){ return String(s||'').toLowerCase().replace(/\b([\p{L}\p{M}][\p{L}\p{M}'-]*)/gu,m=>m.charAt(0).toUpperCase()+m.slice(1)); }
  function guessSep(sampleText){
    const sample = sampleText.split('\n').slice(0,3).join('');
    const sc=(sample.match(/;/g)||[]).length, cc=(sample.match(/,/g)||[]).length;
    return sc>cc ? ';' : ',';
  }
  function parseCSV(text){
    if(!text || !text.trim()) return [];
    // BOM
    text = text.replace(/^\uFEFF/, '');
    const sep = guessSep(text);
    const lines = text.split(/\r?\n/);
    const out = [];
    for (let line of lines){
      if (!line.trim()) continue;
      const row=[]; let cur='', inQ=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i], nx=line[i+1];
        if(ch==='"' && nx==='"'){ cur+='"'; i++; continue; }
        if(ch==='"'){ inQ=!inQ; continue; }
        if(ch===sep && !inQ){ row.push(cur.trim()); cur=''; continue; }
        cur+=ch;
      }
      row.push(cur.trim());
      out.push(row);
    }
    return out.filter(r => r.some(c => String(c||'').trim()!==''));
  }
  function toCSV(rows, sep=','){
    return rows.map(r => r.map(c => {
      const s = String(c ?? '');
      return /["\n,;\t]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
    }).join(sep)).join('\n');
  }
  function updateStats(){
    if (!data || !data.length){ elStats.textContent = '0 filas · 0 columnas'; return; }
    const cols = Math.max(...data.map(r=>r.length));
    elStats.textContent = `${Math.max(0,data.length-1)} filas · ${cols} columnas`;
  }
  function render(){
    elThead.innerHTML=''; elTbody.innerHTML='';
    if(!data.length){ updateStats(); return; }
    const cols = Math.max(...data.map(r=>r.length));
    const trh=document.createElement('tr');
    for(let c=0;c<cols;c++){
      const th=document.createElement('th');
      th.textContent = data[0][c] ?? ('Col '+(c+1));
      trh.appendChild(th);
    }
    elThead.appendChild(trh);
    for(let r=1;r<data.length;r++){
      const tr=document.createElement('tr');
      for(let c=0;c<cols;c++){
        const td=document.createElement('td');
        td.textContent = data[r][c] ?? '';
        tr.appendChild(td);
      }
      elTbody.appendChild(tr);
    }
    updateStats();
  }

  // ======= Smart headers (mapa de sinónimos) =======
  const HEADER_MAP = {
    nombre: /^(nombre|name|nombres?)$/i,
    correo: /^(correo|email|e-?mail|mail)$/i,
    rut: /^(rut|r\.?u\.?t\.?)$/i,
    fecha: /^(fecha|date|f\.?e\.?c\.?h\.?a\.?)$/i,
    ciudad:/^(ciudad|comuna|city)$/i,
    monto:/^(monto|amount|valor|total)$/i
  };
  function normalizeHeaders(headers){
    return headers.map(h=>{
      const raw=String(h||'').replace(/^\uFEFF/,'').trim();
      const titled=toTitle(raw);
      for(const k in HEADER_MAP){ if(HEADER_MAP[k].test(raw)) return toTitle(k); }
      return titled;
    });
  }
  function ensureHeaders(rows){
    if(!rows.length) return [];
    // Heurística: si todas las celdas de la 1ª fila parecen datos (no cabeceras), genera Col 1..N
    const first=rows[0];
    const looksHeader = first.some(c => /[a-zA-Z]/.test(String(c||''))) && !first.every(c => /^\d+([.,]\d+)?$/.test(String(c||'')));
    if(!looksHeader){
      const cols = Math.max(...rows.map(r=>r.length));
      const hdr = Array.from({length:cols}, (_,i)=>`Col ${i+1}`);
      return [hdr, ...rows];
    }
    // Sí hay cabecera → normalízala
    const hdrNorm = normalizeHeaders(first);
    return [hdrNorm, ...rows.slice(1)];
  }

  // ======= Acciones =======
  const actions = {
    trim(){ for(let r=1;r<data.length;r++) data[r]=data[r].map(c=>String(c??'').trim()); },
    collapse(){ for(let r=1;r<data.length;r++) data[r]=data[r].map(c=>String(c??'').replace(/\s+/g,' ').trim()); },
    lower(){ for(let r=1;r<data.length;r++) data[r]=data[r].map(c=>String(c??'').toLowerCase()); },
    upper(){ for(let r=1;r<data.length;r++) data[r]=data[r].map(c=>String(c??'').toUpperCase()); },
    title(){ for(let r=1;r<data.length;r++) data[r]=data[r].map(c=>toTitle(String(c??''))); },
    normalize(){ for(let r=1;r<data.length;r++) data[r]=data[r].map(c=> String(c??'').normalize('NFD').replace(/[\u0300-\u036f]/g,'')); },
    'drop-empty'(){ data=[data[0], ...data.slice(1).filter(r=> r.some(c=> String(c||'').trim()!==''))]; },
    dedupe(){
      const seen=new Set(); const out=[data[0]];
      for(let r=1;r<data.length;r++){ const k=JSON.stringify(data[r]); if(!seen.has(k)){ seen.add(k); out.push(data[r]); } }
      data=out;
    },
    date(){
      const fix=v=>{
        const s=String(v??'').trim();
        const m=s.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})$/);
        if(!m) return v;
        let a=+m[1], b=+m[2], c=+m[3]; if(c<100) c+=2000;
        let d,M,y;
        if(a>12){ d=a; M=b; y=c; }
        else if(a<=12 && b>12){ d=b; M=a; y=c; }
        else { d=a; M=b; y=c; }
        return y+'-'+String(M).padStart(2,'0')+'-'+String(d).padStart(2,'0');
      };
      for(let r=1;r<data.length;r++) data[r]=data[r].map(fix);
    }
  };

  // ======= RUT Pro =======
  const RUT_MINLEN=7, RUT_MAXLEN=8, RUT_STRICT=true;
  const rutClean = s => String(s||'').toUpperCase().replace(/[^0-9K]/g,'');
  function rutCalcDV(body){
    let sum=0, mul=2;
    for(let i=body.length-1;i>=0;i--){ sum+=mul*(+body[i]); mul = (mul===7)?2:(mul+1); }
    const res=11-(sum%11);
    return res===11?'0':(res===10?'K':String(res));
  }
  const rutFormat=(body,dv)=> body.replace(/\B(?=(\d{3})+(?!\d))/g,'.')+'-'+dv;
  const rutLooksReal=(body)=>{
    if(!RUT_STRICT) return true;
    if(!/^\d+$/.test(body)) return false;
    if(body.length<RUT_MINLEN || body.length>RUT_MAXLEN) return false;
    if(/^0+$/.test(body)) return false;
    if(/^(\d)\1+$/.test(body)) return false;
    return true;
  };
  function detectRutCol(headers, sample){
    let idx=headers.findIndex(h=>/rut/i.test(String(h||'')));
    if(idx<0 && sample){ for(let c=0;c<sample.length;c++){ const v=String(sample[c]||''); if(/[0-9Kk\.\-]{7,12}/.test(v)){ idx=c; break; } } }
    return idx<0?0:idx;
  }
  function rutNormalize(){
    if(!data.length) return;
    const headers=data[0].slice();
    const idx=detectRutCol(headers, data[1]);
    let col=headers.findIndex(h=>/RUT_Normalizado/i.test(String(h||'')));
    if(col<0){ col=headers.length; headers.push('RUT_Normalizado'); }
    const out=[headers];
    for(let i=1;i<data.length;i++){
      const row=data[i].slice();
      const cleaned=rutClean(row[idx]||'');
      if(cleaned.length>=2){
        const body=cleaned.slice(0,-1), dv=cleaned.slice(-1);
        if(rutLooksReal(body)){
          const ok=rutCalcDV(body)===dv;
          row[col]=rutFormat(body,dv)+(ok?'':' ⚠️');
        } else row[col]='';
      } else row[col]='';
      out.push(row);
    }
    data=out; render();
  }
  function rutValidate(){
    if(!data.length) return;
    const headers=data[0].slice();
    const idx=detectRutCol(headers,data[1]);
    let col=headers.findIndex(h=>/RUT_Valido/i.test(String(h||'')));
    if(col<0){ col=headers.length; headers.push('RUT_Valido'); }
    const out=[headers];
    for(let i=1;i<data.length;i++){
      const row=data[i].slice();
      const cleaned=rutClean(row[idx]||'');
      let ok=false;
      if(cleaned.length>=2){
        const body=cleaned.slice(0,-1), dv=cleaned.slice(-1);
        ok = rutLooksReal(body) && (rutCalcDV(body)===dv);
      }
      row[col]= ok?'Sí':'No';
      out.push(row);
    }
    data=out; render();
  }
  function rutDuplicates(){
    if(!data.length) return;
    const headers=data[0].slice();
    const idx=detectRutCol(headers,data[1]);
    let col=headers.findIndex(h=>/RUT_Duplicado/i.test(String(h||'')));
    if(col<0){ col=headers.length; headers.push('RUT_Duplicado'); }
    const counts=new Map();
    data.slice(1).forEach(r=>{ const k=rutClean(r[idx]||''); if(!k) return; counts.set(k,(counts.get(k)||0)+1); });
    const out=[headers];
    for(let i=1;i<data.length;i++){
      const row=data[i].slice();
      const k=rutClean(row[idx]||'');
      row[col]= (k && counts.get(k)>1)?'Sí':'No';
      out.push(row);
    }
    data=out; render();
  }

  // Filtros por RUT
  $("#keep-valid").addEventListener('click', ()=>{
    if(!data.length) return;
    const headers=data[0]; const idx=detectRutCol(headers,data[1]);
    data=[headers, ...data.slice(1).filter(r=>{
      const cl=rutClean(r[idx]||''); if(cl.length<2) return false;
      const body=cl.slice(0,-1), dv=cl.slice(-1);
      return rutLooksReal(body) && (rutCalcDV(body)===dv);
    })];
    render();
  });
  $("#dedupe-by-rut").addEventListener('click', ()=>{
    if(!data.length) return;
    const headers=data[0]; const idx=detectRutCol(headers,data[1]);
    const seen=new Set(); const out=[headers];
    for(let i=1;i<data.length;i++){
      const k=rutClean(data[i][idx]||''); if(!k) continue;
      if(!seen.has(k)){ seen.add(k); out.push(data[i]); }
    }
    data=out; render();
  });
  $("#only-dupes").addEventListener('click', ()=>{
    if(!data.length) return;
    const headers=data[0]; const idx=detectRutCol(headers,data[1]);
    const counts=new Map();
    data.slice(1).forEach(r=>{ const k=rutClean(r[idx]||''); if(!k) return; counts.set(k,(counts.get(k)||0)+1); });
    data=[headers, ...data.slice(1).filter(r=> counts.get(rutClean(r[idx]||''))>1 )];
    render();
  });

  // Bind chips
  $$(".chip[data-act]").forEach(b => b.addEventListener('click', ()=>{
    const act=b.getAttribute('data-act');
    if(act==='rut-normalize') rutNormalize();
    else if(act==='rut-validate') rutValidate();
    else if(act==='rut-duplicates') rutDuplicates();
    else if(actions[act]){ actions[act](); render(); }
  }));

  // ======= Carga desde UI =======
  function handleCsvText(text){
    const rows = parseCSV(text);
    data = ensureHeaders(rows);
    render();
  }
  async function handleBinaryXlsx(buf){
    const wb=XLSX.read(buf,{type:'array',cellDates:true});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:false,dateNF:"yyyy-mm-dd"});
    const clean=rows.filter(r => (r||[]).some(c => String(c||'').trim()!==''));
    data = ensureHeaders(clean);
    render();
  }
  $("#load").addEventListener('click', ()=> handleCsvText(TA.value.trim()));
  $("#clear").addEventListener('click', ()=>{ TA.value=''; data=[]; render(); });
  $("#demo").addEventListener('click', ()=>{
    TA.value = `Nombre,Correo,RUT,Fecha,Ciudad,Monto
ANA,ana@example.com,12.345.678-5,1/2/24,ViÑA del Mar,12000
Ana,ana@example.com,12.345.678-5,01-02-2024,viña  del   mar,12000
Pedro,pedro@example.com,9.876.543-K,12/31/2023,santiago,35000
María José,mjose@example.com,7.654.321-0,05-07-2024,Providencia,18000
Juan Pérez,juan.perez@example.com,11.111.111-1,2024-01-15,La Florida,5000
JUAN,juan@example.com,9876543k,5-7-2024,PROVIDENCIA,0`;
    $("#load").click();
  });

  // File & DnD
  $("#file").addEventListener('change', async e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const ext=f.name.toLowerCase().split('.').pop(); const buf=await f.arrayBuffer();
    if(ext==='csv'){ const txt=new TextDecoder('utf-8').decode(buf); handleCsvText(txt); }
    else { await handleBinaryXlsx(buf); }
    e.target.value='';
  });
  const dz=$("#drop");
  ;['dragenter','dragover'].forEach(ev=> dz.addEventListener(ev,e=>{e.preventDefault(); dz.classList.add('is-drop');}));
  ;['dragleave','drop'].forEach(ev=> dz.addEventListener(ev,e=>{e.preventDefault(); dz.classList.remove('is-drop');}));
  dz.addEventListener('drop', async e=>{
    const f=e.dataTransfer?.files?.[0]; if(!f) return;
    const ext=f.name.toLowerCase().split('.').pop(); const buf=await f.arrayBuffer();
    if(ext==='csv'){ const txt=new TextDecoder('utf-8').decode(buf); handleCsvText(txt); }
    else { await handleBinaryXlsx(buf); }
  });
  dz.addEventListener('click', ()=> $("#file").click());

  // ======= Export =======
  $("#copyCsv").addEventListener('click', async ()=>{
    if(!data.length) return;
    const headers=(data[0]||[]).map(toTitle);
    const body=data.slice(1).filter(r=> r.some(c=> String(c||'').trim()!==''));
    await navigator.clipboard.writeText(toCSV([headers, ...body]));
    const t=$("#copyCsv").textContent; $("#copyCsv").textContent="¡Copiado!"; setTimeout(()=>$("#copyCsv").textContent=t,1100);
  });
  $("#downloadCsv").addEventListener('click', ()=>{
    if(!data.length) return;
    const headers=(data[0]||[]).map(toTitle);
    const body=data.slice(1).filter(r=> r.some(c=> String(c||'').trim()!==''));
    const csv=toCSV([headers, ...body]);
    const blob=new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='rockcode_datacleaner.csv'; a.click(); URL.revokeObjectURL(url);
  });
  $("#downloadXls").addEventListener('click', ()=>{
    if(!data.length) return;
    const headers=(data[0]||[]).map(h=> String(h||'').trim().replace(/_/g,' '));
    const body=data.slice(1).filter(r=> r.some(c=> String(c||'').trim()!==''));
    const rows=[headers, ...body];
    const htmlRows = rows.map((r,i)=>'<tr>'+r.map(c => (i===0?'<th>':'<td>')+String(c??'').replace(/&/g,'&amp;').replace(/</g,'&lt;')+(i===0?'</th>':'</td>')).join('')+'</tr>').join('');
    const html=`<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="utf-8">
    <!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>DataCleaner</x:Name><x:WorksheetOptions><x:Print/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table border="1">${htmlRows}</table></body></html>`;
    const blob=new Blob([html],{type:'application/vnd.ms-excel'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='rockcode_datacleaner.xls'; a.click(); URL.revokeObjectURL(url);
  });
  $("#downloadXlsx").addEventListener('click', ()=>{
    if(!window.XLSX){ alert('Falta XLSX (CDN)'); return; }
    if(!data.length) return;
    const headersRaw=data[0]||[];
    const headers=headersRaw.map(h=> String(h||'').trim().replace(/_/g,' '));
    const body=data.slice(1).filter(r=> r.some(c=> String(c||'').trim()!==''));
    const toISO=v=> /^\d{4}-\d{2}-\d{2}$/.test(String(v||''));
    const rows=[headers, ...body.map(row=> row.map((v,i)=>{
      const s=String(v??'').trim();
      if(toISO(s)) return new Date(s+'T00:00:00');
      if(/(edad|monto|amount|valor|total|tiempo|id|cantidad|nro|número)/i.test(headers[i]||'')){
        const n=Number(s.replace(/\./g,'').replace(',', '.')); if(!isNaN(n)) return n;
      }
      return v;
    }))];
    const ws=XLSX.utils.aoa_to_sheet(rows,{cellDates:true});
    const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'DataCleaner');
    const range=XLSX.utils.decode_range(ws['!ref']);
    ws['!cols']=headers.map((h,c)=>{ let m=String(h).length; for(let r=1;r<=range.e.r;r++){ const L=String(rows[r]?.[c]??'').length; if(L>m) m=L; } return {wch: Math.min(Math.max(10,m+2),48)}; });
    ws['!freeze']={xSplit:0,ySplit:1}; ws['!autofilter']={ref:ws['!ref']};
    XLSX.writeFile(wb,'rockcode_datacleaner.xlsx');
  });

  // ======= Estado (LocalStorage) =======
  const KEY='rockcode_datacleaner_aoa';
  $("#save-state").addEventListener('click', ()=>{ if(!data.length) return; localStorage.setItem(KEY, JSON.stringify(data)); alert('Estado guardado.'); });
  $("#restore-state").addEventListener('click', ()=>{ const s=localStorage.getItem(KEY); if(!s) return; data=JSON.parse(s); render(); });

  // ======= Atajos =======
  document.addEventListener('keydown', (e)=>{
    if(e.ctrlKey && e.key.toLowerCase()==='enter'){ e.preventDefault(); $("#load").click(); }
    if(e.ctrlKey && e.key.toLowerCase()==='k'){ e.preventDefault(); TA.focus(); TA.select(); }
  });

  // ======= Demo inicial si vacío =======
  if(!TA.value.trim()){
    $("#demo").click();
  }
})();
</script>
</body>
</html>
