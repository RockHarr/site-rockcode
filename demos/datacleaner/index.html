<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DataCleaner — RockCode</title>
  <meta name="description" content="Limpia y valida datos CSV/Excel: quitar duplicados, normalizar fechas/textos y RUT.">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%2300d084%22/></svg>">
  <style>
    :root{
      --bg:#0b1220; --ink:#e5e7eb; --muted:#94a3b8; --line:#1f2937; --accent:#22c55e;
      --card:rgba(255,255,255,.02);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,sans-serif;
      background:#0b1220; color:var(--ink);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .h1{font-size:clamp(20px,4vw,28px);margin:0 0 14px;font-weight:700}
    .muted{color:var(--muted)}
    .pill{border:1px solid var(--line);border-radius:999px;padding:4px 10px;color:var(--muted);font-size:12px}
    .btn{
      appearance:none;border:1px solid var(--line);background:#0f172a;color:var(--ink);
      padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer
    }
    .btn.primary{background:var(--accent);color:#062b14;border-color:#16a34a}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px}
    .hd{padding:12px 14px;border-bottom:1px dashed var(--line);display:flex;gap:10px;align-items:center;justify-content:space-between}
    .bd{padding:14px}
    .grid2{display:grid;gap:16px;grid-template-columns:1fr 1fr}
    @media (max-width:900px){.grid2{grid-template-columns:1fr}}
    input,textarea{
      width:100%;background:#0b1220;border:1px solid var(--line);border-radius:12px;color:var(--ink);padding:10px
    }
    label{display:block;font-size:14px;margin:10px 0 6px;color:var(--muted)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    table{border-collapse:collapse;width:100%;background:var(--card);font-size:13px}
    th{background:#111827;color:#9ca3af;font-weight:600;position:sticky;top:0}
    td,th{border:1px solid #1f2937;padding:6px 8px;text-align:left;white-space:nowrap}
    tbody tr:nth-child(even){background:rgba(255,255,255,.03)}
    footer{border-top:1px solid var(--line);margin-top:18px;color:var(--muted);font-size:12px;padding-top:12px}
  </style>
</head>
<body>
  <main class="wrap">
    <div class="card">
      <div class="hd">
        <div>
          <div class="h1">DataCleaner</div>
          <div class="muted">Limpia datos en segundos: CSV/Excel, RUT, fechas, duplicados.</div>
        </div>
        <span class="pill" id="meta">0 filas · 0 columnas</span>
      </div>

      <div class="bd grid2">
        <div>
          <label>Pega tus datos (CSV con coma o punto y coma)</label>
          <textarea id="raw" style="min-height:180px"></textarea>
          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="load">Cargar</button>
            <button class="btn" id="clear">Limpiar</button>
          </div>
        </div>

        <div>
          <label>Acciones</label>
          <div class="row">
            <button class="btn" data-act="trim">Quitar espacios</button>
            <button class="btn" data-act="collapse">Espacios múltiples → uno</button>
            <button class="btn" data-act="lower">minúsculas</button>
            <button class="btn" data-act="upper">MAYÚSCULAS</button>
            <button class="btn" data-act="title">Título</button>
            <button class="btn" data-act="dedupe">Eliminar duplicados</button>
            <button class="btn" data-act="drop-empty">Eliminar filas vacías</button>
            <button class="btn" data-act="normalize">Quitar acentos</button>
            <button class="btn" data-act="date">Normalizar fecha</button>
            <button class="btn" data-act="rut-normalize">Normalizar RUT</button>
            <button class="btn" data-act="rut-validate">Validar RUT</button>
            <button class="btn" data-act="rut-duplicates">Etiquetar duplicados RUT</button>
          </div>
        </div>
      </div>

      <div class="bd" style="max-height:50vh;overflow:auto;border-top:1px dashed var(--line)">
        <table id="table"></table>
      </div>

      <div class="bd row">
        <button class="btn" id="copyCsv">Copiar CSV</button>
        <button class="btn" id="downloadCsv">Descargar CSV (ordenado)</button>
        <button class="btn" id="downloadXls">Descargar Excel (XLS)</button>
        <button class="btn primary" id="downloadXlsx">Descargar Excel (XLSX)</button>
      </div>
    </div>

    <footer>
      © <span id="y"></span> RockCode — DataCleaner. Diseño & desarrollo: Rockwell Harrison + Spark (ChatGPT)
    </footer>
  </main>

  <!-- Debe existir en la misma carpeta -->
  <script src="xlsx.full.min.js"></script>
  <script>
  (function(){
    const $ = (id)=>document.getElementById(id);
    const meta=$('meta'), table=$('table'); let data=[];

    function parseCSV(text) {
  // 1) Normaliza saltos de línea a \n (soporta \r\n, \n o \r)
  const norm = String(text ?? '').replace(/\r\n|\n|\r/g, '\n');
  if (!norm.trim()) return [];

  // 2) Detecta separador entre coma y punto y coma (en primeras líneas),
  //    si no hay, intenta con tabulador.
  const first = norm.split('\n').slice(0, 3).join('\n');
  let sep = ',';
  const cntComma = (first.match(/,/g) || []).length;
  const cntSemi  = (first.match(/;/g) || []).length;
  const cntTab   = (first.match(/\t/g) || []).length;
  if (cntSemi > cntComma && cntSemi >= cntTab) sep = ';';
  else if (cntTab > Math.max(cntComma, cntSemi)) sep = '\t';

  // 3) Parse carácter por carácter con comillas
  const lines = norm.split('\n');
  const rows = [];
  for (let line of lines) {
    // Permite líneas en blanco
    if (line === '') continue;
    const row = [];
    let cur = '', inQ = false;

    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      const nx = line[i + 1];

      if (ch === '"' && nx === '"') { cur += '"'; i++; }         // comilla escapada
      else if (ch === '"') { inQ = !inQ; }                       // abrir/cerrar comillas
      else if (ch === sep && !inQ) { row.push(cur.trim()); cur=''; } // separador
      else { cur += ch; }
    }
    row.push(cur.trim());
    // filtra filas totalmente vacías
    if (row.some(c => String(c).trim() !== '')) rows.push(row);
  }

  // 4) Fallback: si por algún motivo quedó 1 sola fila gigante, intenta forzar split
  if (rows.length === 1 && (rows[0] || []).length > 15 && norm.includes('\n')) {
    return norm.split('\n').filter(l => l.trim() !== '').map(l => l.split(sep).map(c => c.trim()));
  }
  return rows;
}


    function toCSV(rows,sep=','){
      return rows.map(r => r.map(c => {
        const s = String(c ?? '');
        return /["\\n,;\\t]/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s;
      }).join(sep)).join('\\n');
    }

    function render(){
      table.innerHTML='';
      if(!data.length){ meta.textContent='0 filas · 0 columnas'; return; }
      const cols=Math.max(...data.map(r=>r.length));
      let thead='<thead><tr>';
      for(let i=0;i<cols;i++) thead+=`<th>${data[0][i]||('Col '+(i+1))}</th>`;
      thead+='</tr></thead>';
      let body='<tbody>';
      data.slice(1).forEach(r=>{
        body+='<tr>';
        for(let i=0;i<cols;i++) body+=`<td>${(r[i]??'')}</td>`;
        body+='</tr>';
      });
      body+='</tbody>';
      table.innerHTML=thead+body;
      meta.textContent=`${data.length-1} filas · ${cols} columnas`;
    }

    const actions = {
      'trim':()=>{ for(let r=1;r<data.length;r++) data[r]=data[r].map(c=>String(c??'').trim()); },
      'collapse':()=>{ for(let r=1;r<data.length;r++) data[r]=data[r].map(c=>String(c??'').replace(/\\s+/g,' ').trim()); },
      'lower':()=>{ for(let r=1;r<data.length;r++) data[r]=data[r].map(c=>String(c??'').toLowerCase()); },
      'upper':()=>{ for(let r=1;r<data.length;r++) data[r]=data[r].map(c=>String(c??'').toUpperCase()); },
      'title':()=>{ const tt=s=> s.toLowerCase().replace(/\\b([\\p{L}\\p{M}][\\p{L}\\p{M}'-]*)/gu,m=>m.charAt(0).toUpperCase()+m.slice(1)); for(let r=1;r<data.length;r++) data[r]=data[r].map(c=>tt(String(c??''))); },
      'dedupe':()=>{ const seen=new Set(); const out=[data[0]]; for(let r=1;r<data.length;r++){ const k=JSON.stringify(data[r]); if(!seen.has(k)){ seen.add(k); out.push(data[r]); } } data=out; },
      'drop-empty':()=>{ data=[data[0], ...data.slice(1).filter(r => r.some(c => String(c||'').trim() !== ''))]; },
      'normalize':()=>{ for(let r=1;r<data.length;r++) data[r]=data[r].map(c=> String(c??'').normalize('NFD').replace(/[\\u0300-\\u036f]/g,'')); },
      'date':()=>{ const fix=v=>{ const s=String(v??'').trim(); const m=s.match(/^(\\d{1,2})[\\/-](\\d{1,2})[\\/-](\\d{2,4})$/); if(!m) return v; let a=+m[1], b=+m[2], c=+m[3]; if(c<100) c+=2000; let day,mon,yr; if(a>12){day=a;mon=b;yr=c;} else if(a<=12 && b>12){day=b;mon=a;yr=c;} else {day=a;mon=b;yr=c;} return yr+'-'+String(mon).padStart(2,'0')+'-'+String(day).padStart(2,'0'); }; for(let r=1;r<data.length;r++) data[r]=data[r].map(fix); },

      _rut_detect:(headers,sample)=>{ let idx=headers.findIndex(h=>/rut/i.test(String(h||''))); if(idx<0 && sample){ for(let c=0;c<sample.length;c++){ const v=String(sample[c]||''); if(/[0-9Kk\\.\\-]{7,12}/.test(v)){ idx=c; break; } } } if(idx<0) idx=0; return idx; },
      _rut_clean:s=> String(s||'').toUpperCase().replace(/[^0-9K]/g,''),
      _rut_calcDV:body=>{ let sum=0,mul=2; for(let i=body.length-1;i>=0;i--){ sum+=mul*(+body[i]); mul = (mul===7)?2:(mul+1); } const res=11-(sum%11); return res===11?'0':(res===10?'K':String(res)); },
      _rut_format:(body,dv)=> body.replace(/\\B(?=(\\d{3})+(?!\\d))/g,'.')+'-'+dv,

      'rut-normalize':function(){
        if(!data.length) return;
        const headers=data[0]||[]; const idx=this._rut_detect(headers, data[1]);
        data = data.map((row,i)=>{
          if(i===0) return row;
          const raw=String(row[idx]||''); if(!raw.trim()) return row;
          const cleaned=this._rut_clean(raw); if(cleaned.length<2) return row;
          const body=cleaned.slice(0,-1), dv=cleaned.slice(-1);
          const ok=this._rut_calcDV(body)===dv;
          const formatted=this._rut_format(body,dv);
          const copy=row.slice(); copy[idx]= ok? formatted : formatted+' ⚠️'; return copy;
        });
      },

      'rut-validate':function(){
        if(!data.length) return;
        const headers=data[0].slice(); let col=headers.findIndex(h=>/RUT_Valido/i.test(String(h||'')));
        if(col<0){ col=headers.length; headers.push('RUT_Valido'); }
        const idx=this._rut_detect(data[0], data[1]);
        const out=[headers].concat(data.slice(1).map(row=>{
          const r=row.slice(); const cleaned=this._rut_clean(r[idx]); let ok=false;
          if(cleaned.length>=2){ const body=cleaned.slice(0,-1), dv=cleaned.slice(-1); ok=this._rut_calcDV(body)===dv; }
          r[col]= ok? 'Sí':'No'; return r;
        }));
        data=out;
      },

      'rut-duplicates':function(){
        if(!data.length) return;
        const headers=data[0].slice(); let col=headers.findIndex(h=>/RUT_Duplicado/i.test(String(h||'')));
        if(col<0){ col=headers.length; headers.push('RUT_Duplicado'); }
        const idx=this._rut_detect(data[0], data[1]); const counts=new Map();
        data.slice(1).forEach(r=>{ const k=this._rut_clean(r[idx]||''); if(!k) return; counts.set(k, (counts.get(k)||0)+1); });
        const out=[headers].concat(data.slice(1).map(row=>{
          const r=row.slice(); const key=this._rut_clean(r[idx]||''); r[col]= key && counts.get(key)>1 ? 'Sí':'No'; return r;
        }));
        data=out;
      },
    };

    document.querySelectorAll('[data-act]').forEach(b=> b.addEventListener('click', ()=>{ const act=b.getAttribute('data-act'); if(actions[act]){ actions[act](); render(); } }));

    $('load').addEventListener('click', ()=>{
      const raw=$('raw').value.trim();
      data = raw? parseCSV(raw): [];
      render();
    });

    $('clear').addEventListener('click', ()=>{
      $('raw').value=''; data=[]; render();
    });

    const toTitle=s=> String(s||'').toLowerCase().replace(/\\b([\\p{L}\\p{M}][\\p{L}\\p{M}'-]*)/gu,m=>m.charAt(0).toUpperCase()+m.slice(1));

    $('copyCsv').addEventListener('click', async ()=>{
      if(!data.length) return;
      const headers = (data[0]||[]).map(toTitle);
      const body = data.slice(1).filter(r => r.some(c => String(c||'').trim() !== ''));
      await navigator.clipboard.writeText(toCSV([headers, ...body]));
      const btn=this.event?.target || $('copyCsv'); const t=btn.textContent; btn.textContent='¡Copiado!'; setTimeout(()=>btn.textContent=t,1200);
    });

    $('downloadCsv').addEventListener('click', ()=>{
      if(!data.length) return;
      const headers = (data[0]||[]).map(toTitle);
      const body = data.slice(1).filter(r => r.some(c => String(c||'').trim() !== ''));
      const csv = toCSV([headers, ...body]);
      const blob = new Blob(['\\ufeff'+csv], {type:'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='rockcode_datacleaner.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    function exportXLS_HTML(){
      if(!data || !data.length) return;
      const headers = (data[0]||[]).map(h => String(h||'').trim().replace(/_/g,' '));
      const body = data.slice(1).filter(r => r.some(c => String(c||'').trim() !== ''));
      const rows = [headers, ...body];
      const htmlTable = rows.map((r,i)=>'<tr>'+r.map(c=> (i===0?'<th>':'<td>') + String(c??'').replace(/&/g,'&amp;').replace(/</g,'&lt;') + (i===0?'</th>':'</td>')).join('') + '</tr>').join('');
      const html = `
      <html xmlns:o="urn:schemas-microsoft-com:office:office"
            xmlns:x="urn:schemas-microsoft-com:office:excel"
            xmlns="http://www.w3.org/TR/REC-html40">
      <head><meta charset="utf-8"><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet>
      <x:Name>DataCleaner</x:Name><x:WorksheetOptions><x:Print/></x:WorksheetOptions></x:ExcelWorksheet>
      </x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head>
      <body><table border="1">${htmlTable}</table></body></html>`;
      const blob = new Blob([html], {type: 'application/vnd.ms-excel'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='rockcode_datacleaner.xls'; a.click();
      URL.revokeObjectURL(url);
    }

    function exportXLSX_Nativo(){
      if (!window.XLSX) { alert('Para XLSX, coloca xlsx.full.min.js junto a este index.html'); return; }
      if (!data || !data.length) return;
      const headersRaw = data[0] || [];
      const headers = headersRaw.map(h => String(h||'').trim().replace(/_/g,' '));
      const body = data.slice(1).filter(r => r.some(c => String(c||'').trim() !== ''));
      const toISO = v => /^\\d{4}-\\d{2}-\\d{2}$/.test(String(v||''));
      const rows = [headers, ...body.map(row => row.map((v,i) => {
        const s = String(v ?? '').trim();
        if (toISO(s)) return new Date(s + 'T00:00:00');
        if (/(edad|monto|total|tiempo|id|cantidad|nro|número)/i.test(headers[i]||'')) {
          const n = Number(s.replace(/\\./g,'').replace(',', '.')); if(!isNaN(n)) return n;
        }
        return v;
      }))];
      const ws = XLSX.utils.aoa_to_sheet(rows, { cellDates: true });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'DataCleaner');
      const range = XLSX.utils.decode_range(ws['!ref']);
      ws['!cols'] = headers.map((h, c) => {
        let maxLen = String(h).length;
        for (let r = 1; r <= range.e.r; r++) {
          const L = String(rows[r]?.[c] ?? '').length;
          if (L > maxLen) maxLen = L;
        }
        return { wch: Math.min(Math.max(10, maxLen + 2), 48) };
      });
      ws['!freeze'] = { xSplit: 0, ySplit: 1 };
      ws['!autofilter'] = { ref: ws['!ref'] };
      XLSX.writeFile(wb, 'rockcode_datacleaner.xlsx');
    }

    $('downloadXls').addEventListener('click', exportXLS_HTML);
    $('downloadXlsx').addEventListener('click', exportXLSX_Nativo);

    document.getElementById('y').textContent = new Date().getFullYear();

    // Semilla de ejemplo (opcional)
    const sample = `nombre,correo,rut,fecha,ciudad
ANA, ana@example.com, 12345678-5, 1/2/24, ViÑA del Mar
Ana, ana@example.com, 12.345.678-5, 01-02-2024, viña  del   mar
Pedro, pedro@example.com, 11111111-1, 12/31/2023, santiago
 , , , , 
JUAN, juan@example.com, 9876543k, 5-7-2024, PROVIDENCIA`;
    if(!$('raw').value) $('raw').value = sample;
  })();
  </script>
</body>
</html>
