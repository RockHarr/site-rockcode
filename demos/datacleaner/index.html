<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DataCleaner · RockCode</title>
  <meta name="description" content="DataCleaner: limpia y valida datos CSV/Excel (RUT, fechas, duplicados) en segundos. Hecho por RockCode con Spark (ChatGPT).">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1320; --panel:#0f172a; --ink:#e5e7eb; --muted:#94a3b8;
      --line:#2b3447; --accent:#22c55e; --ring:#3a86ff;
      --hover:#182236; --warn:#f59e0b; --bad:#ef4444; --good:#22c55e;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,sans-serif;
      color:var(--ink); background:linear-gradient(180deg,#0a1020,#0b1320 30%, #0b1320 100%);
    }

    .wrap{max-width:1180px;margin:0 auto;padding:20px 16px}
    header{position:sticky;top:0;z-index:20;background:rgba(11,19,32,.65);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
    .nav{display:flex;gap:14px;align-items:center;justify-content:space-between;padding:12px 0}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(145deg,#10b981,#22c55e);box-shadow:inset 0 0 12px rgba(0,0,0,.35)}
    h1{font-size:clamp(22px,3.6vw,34px);margin:0}
    .sub{color:var(--muted);font-size:14px}

    .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.35);padding:16px}
    .row{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    @media (max-width:960px){ .row{grid-template-columns:1fr} }

    label{display:block;color:var(--muted);font-size:14px;margin-bottom:8px}
    textarea{
      width:100%;min-height:190px;background:#0b1220;border:1px solid var(--line);
      color:var(--ink);border-radius:14px;padding:10px 12px;resize:vertical
    }
    .drop{
      display:flex;align-items:center;justify-content:center;
      border:1px dashed var(--line);border-radius:14px;min-height:70px;color:var(--muted);
      background:#0b1220;
    }
    .drop.drag{border-color:#3a86ff;color:#cfe1ff;background:#0d1530}

    .controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);color:var(--muted);
      padding:.25rem .6rem;border-radius:999px;font-size:12px
    }

    /* Tabla */
    .tableWrap{margin-top:14px;border:1px solid var(--line);border-radius:14px;overflow:auto;max-height:50vh;background:rgba(255,255,255,.02)}
    table{border-collapse:collapse;width:100%;font-size:14px}
    th,td{border-bottom:1px solid #1f2937;padding:8px 10px;white-space:nowrap;text-align:left}
    thead th{position:sticky;top:0;background:#101a2f;color:#b3c1d9;font-weight:700;z-index:1}
    tbody tr:nth-child(even){background:rgba(255,255,255,.02)}
    .warn{color:var(--warn);font-weight:700}
    .bad{color:var(--bad);font-weight:700}
    .good{color:var(--good);font-weight:700}

    /* Botones base */
    button,.btn{
      --bg:#0f172a; --bd:#2b3447; --ink:#e5e7eb; --hover:#182236; --ring:#3a86ff;
      background:var(--bg); color:var(--ink); border:1px solid var(--bd); border-radius:14px;
      padding:.55rem .9rem; font-weight:700; line-height:1; letter-spacing:.1px;
      display:inline-flex; align-items:center; gap:.4rem; cursor:pointer; user-select:none;
      box-shadow:0 1px 0 rgba(0,0,0,.40), inset 0 0 0 1px rgba(255,255,255,.02);
      transition:background .15s ease, border-color .15s ease, transform .05s ease;
    }
    button:hover{background:var(--hover);border-color:#3b475f}
    button:active{transform:translateY(1px)}
    button:focus-visible{outline:3px solid var(--ring);outline-offset:2px}
    button[disabled]{opacity:.55;cursor:not-allowed}
    .primary{background:var(--accent);border-color:#16a34a;color:#062b14}
    .ghost{background:transparent;border-color:#3b475f}

    /* Acciones — estilo chips AA (aplica a todos los botones dentro) */
    .actions{display:flex;flex-wrap:wrap;gap:10px}
    .actions button,.actions .btn,.actions .chip,.actions a[role="button"]{
      --bg:#0f172a; --bd:#2b3447; --ink:#e5e7eb; --hover:#182236; --ring:#3a86ff;
      background:var(--bg);color:var(--ink);border:1px solid var(--bd);border-radius:14px;
      padding:.55rem .9rem;font-weight:600;line-height:1;letter-spacing:.1px;display:inline-flex;align-items:center;gap:.4rem;
      cursor:pointer;user-select:none;text-decoration:none;box-shadow:0 1px 0 rgba(0,0,0,.40), inset 0 0 0 1px rgba(255,255,255,.02);
      transition:background .15s ease, border-color .15s ease, transform .05s ease;
    }
    .actions button:hover{background:var(--hover);border-color:#3b475f}
    .actions button:active{transform:translateY(1px)}
    .actions button:focus-visible{outline:3px solid var(--ring);outline-offset:2px}
    .actions button[disabled]{opacity:.55;cursor:not-allowed}
    .actions .btn--ghost{background:transparent;border-color:#3b475f}
    .actions .btn--ghost:hover{background:rgba(56,68,94,.25)}

    /* Footer */
    footer{color:var(--muted);font-size:13px;border-top:1px solid var(--line);padding:16px 0;margin-top:16px}
  </style>
</head>
<body>
  <header>
    <div class="wrap nav">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>DataCleaner</h1>
          <div class="sub">Limpia datos en segundos: CSV/Excel, RUT, fechas y duplicados.</div>
        </div>
      </div>
      <div class="badge">AA · Teclado · Focus visible</div>
    </div>
  </header>

  <main class="wrap">
    <section class="panel">
      <div class="row">
        <!-- Col izquierda -->
        <div>
          <label for="raw">Pega tus datos (CSV con coma o punto y coma)</label>
          <textarea id="raw" spellcheck="false" aria-describedby="rawHelp"></textarea>
          <div id="rawHelp" class="sub" style="margin-top:6px">
            Tip: también puedes <strong>arrastrar</strong> un .csv/.xlsx acá abajo o usar el botón.
          </div>

          <div class="controls">
            <button class="primary" id="btnLoad">Cargar</button>
            <button id="btnClear">Limpiar</button>
            <span id="meta" class="badge">0 filas · 0 columnas</span>
          </div>

          <div id="drop" class="drop" style="margin-top:10px" aria-label="Zona para arrastrar archivos">Arrastra aquí un CSV/XLSX o usa “Subir archivo”.</div>
          <div class="controls">
            <label class="btn ghost" for="file">Subir archivo</label>
            <input id="file" type="file" accept=".csv, text/csv, .xls, .xlsx" hidden>
          </div>
        </div>

        <!-- Col derecha -->
        <div>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <h2 style="margin:0;font-size:18px">Acciones</h2>
            <span class="badge" id="stats">—</span>
          </div>

          <h3 class="sub" style="margin:8px 0 6px">Acciones frecuentes</h3>
          <div class="actions" style="margin-bottom:10px">
            <button data-act="trim">Quitar espacios</button>
            <button data-act="collapse">Espacios múltiples → uno</button>
            <button data-act="upper">MAYÚSCULAS</button>
            <button data-act="lower">minúsculas</button>
            <button data-act="title">Título</button>
            <button data-act="normalize">Quitar acentos</button>
            <button data-act="date">Normalizar fecha</button>
            <button data-act="dedupe">Eliminar duplicados</button>
            <button data-act="drop-empty">Quitar filas vacías</button>
          </div>

          <h3 class="sub" style="margin:12px 0 6px">RUT</h3>
          <div class="actions" style="margin-bottom:10px">
            <button data-act="rut-normalize">RUT → formato</button>
            <button data-act="rut-validate">Validar RUT</button>
            <button data-act="rut-duplicates">Etiquetar duplicados RUT</button>
            <button data-act="rut-keep-valid">Mantener RUT válidos</button>
            <button data-act="rut-dedupe">Quitar duplicados por RUT</button>
            <button data-act="rut-only-dupes">Solo duplicados por RUT</button>
          </div>

          <h3 class="sub" style="margin:12px 0 6px">Estado</h3>
          <div class="actions">
            <button id="btnSaveState" class="btn--ghost">Guardar estado</button>
            <button id="btnRestoreState" class="btn--ghost">Restaurar estado</button>
          </div>
        </div>
      </div>

      <!-- Tabla -->
      <div class="tableWrap" id="tableWrap" hidden>
        <table id="table" aria-label="Tabla de datos procesados"></table>
      </div>

      <!-- Export -->
      <div class="controls" style="margin-top:12px">
        <button id="btnCopy">Copiar CSV</button>
        <button id="btnCsvOrdered" class="ghost">Descargar CSV (ordenado)</button>
        <button id="btnXls" class="primary">Descargar Excel (XLS)</button>
        <button id="btnXlsx">Descargar Excel (XLSX)</button>
      </div>
    </section>

    <footer>
      © <span id="year"></span> RockCode · DataCleaner. Diseño & desarrollo: <strong>Rockwell Harrison</strong> + <strong>Spark (ChatGPT)</strong>.
    </footer>
  </main>

  <!-- XLSX para exportar xlsx y leer xlsx -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>

  <script>
  (function(){
    const $ = s => document.querySelector(s);
    const raw = $('#raw');
    const meta = $('#meta');
    const stats = $('#stats');
    const table = $('#table');
    const tableWrap = $('#tableWrap');
    const drop = $('#drop');
    const file = $('#file');

    let data = [];        // Array of arrays
    let header = [];      // First row (headers)
    let delimiter = ',';  // Detected delimiter

    // Seed de ejemplo
    const seed = `nombre,correo,rut,fecha,ciudad,monto
ANA,ana@example.com,12345678-5,1/2/24,ViÑA del Mar,12000
Pedro,pedro@example.com,9.876.543-K,12/31/2023,Santiago,35000
María José,mjose@example.com,7.654.321-0,05-07-2024,Providencia,18000
Juan Pérez,juan.perez@example.com,11.111.111-1,2024-01-15,La Florida,5000
Ana,ana@example.com,12.345.678-5,01-02-2024,viña del mar,12000
Claudia Fuentes,claudia.f@example.com,9.999.999-9,7/8/24,Ñuñoa,100000
Felipe R.,felipe@example.com,1.234.567-9,31-12-2023,Las Condes,20000
Guillermo,guillermo@example.com,12.345.678-9,2023-12-31,Recoleta,15000
Paula,paula@example.com,12.345.678-4,2/1/24,SAN MIGUEL,8000
Sofía,sofia@example.com,9.876.543-K,5-7-2024,Peñalolén,30000
Álvaro,alvaro@example.com,00.000.000-0,01/01/2024,Independencia,0`;

    raw.value = seed;

    // Utils
    const has = (s,re) => re.test(String(s||''));
    const lc = s => String(s||'').toLowerCase();

    function detectDelimiter(text){
      const first = text.split(/\r?\n/).slice(0,3).join("\n");
      const c = (first.match(/,/g)||[]).length;
      const p = (first.match(/;/g)||[]).length;
      return p>c ? ';' : ',';
    }

    function parseCSV(text){
      const d = detectDelimiter(text);
      delimiter = d;
      const lines = text.split(/\r?\n/);
      const rows = [];
      for (let line of lines){
        if (!line.trim()) continue;
        const out = [];
        let cur = '', inQ = false;
        for (let i=0;i<line.length;i++){
          const ch=line[i], nx=line[i+1];
          if (ch === '"' && nx === '"'){ cur+='"'; i++; continue; }
          if (ch === '"'){ inQ=!inQ; continue; }
          if (ch === d && !inQ){ out.push(cur.trim()); cur=''; continue; }
          cur += ch;
        }
        out.push(cur.trim());
        rows.push(out);
      }
      return rows.filter(r => r.some(c => String(c).trim()!==''));
    }

    function toCSV(rows,sep=','){
      return rows.map(r => r.map(c => {
        const s = String(c ?? '');
        return /["\n,;\t]/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s;
      }).join(sep)).join('\n');
    }

    function render(){
      if (!data.length){ table.innerHTML=''; tableWrap.hidden = true; meta.textContent='0 filas · 0 columnas'; stats.textContent='—'; return; }
      tableWrap.hidden = false;
      header = data[0] || [];
      const cols = Math.max(...data.map(r => r.length));
      // thead
      let thead='<thead><tr>';
      for (let i=0;i<cols;i++) thead += `<th>${header[i]||('Col '+(i+1))}</th>`;
      thead+='</tr></thead>';
      // tbody
      let body='<tbody>';
      data.slice(1).forEach(r=>{
        body+='<tr>';
        for (let i=0;i<cols;i++){
          const v = r[i] ?? '';
          body+=`<td>${v}</td>`;
        }
        body+='</tr>';
      });
      body+='</tbody>';
      table.innerHTML = thead + body;
      meta.textContent = `${data.length-1} filas · ${cols} columnas`;
      stats.textContent = `Delim: “${delimiter}” · Encabezados: ${header.length}`;
    }

    function loadFromTextarea(){
      const t = raw.value.trim();
      data = t ? parseCSV(t) : [];
      render();
    }
    function clearAll(){
      raw.value=''; data=[]; render();
    }

    // Acciones de texto/tablas
    const actions = {
      trim: ()=> forEachCell(s=> String(s??'').trim()),
      collapse: ()=> forEachCell(s=> String(s??'').replace(/\s+/g,' ').trim()),
      lower: ()=> forEachCell(s=> String(s??'').toLowerCase()),
      upper: ()=> forEachCell(s=> String(s??'').toUpperCase()),
      title: ()=> forEachCell(s=> String(s??'').toLowerCase().replace(/\b([\p{L}\p{M}][\p{L}\p{M}'-]*)/gu, m=> m.charAt(0).toUpperCase()+m.slice(1))),
      normalize: ()=> forEachCell(s=> String(s??'').normalize('NFD').replace(/[\u0300-\u036f]/g,'')),
      date: ()=> forEachCell(dateFix),
      dedupe: ()=>{
        const seen = new Set(); const out=[data[0]];
        for (let i=1;i<data.length;i++){
          const k = JSON.stringify(data[i]);
          if (!seen.has(k)){ seen.add(k); out.push(data[i]); }
        }
        data = out; render();
      },
      'drop-empty': ()=>{
        data = [data[0], ...data.slice(1).filter(r => r.some(c => String(c||'').trim()!==''))];
        render();
      },

      // RUT helpers
      '_rutColIndex': ()=> {
        // 1) Busca columna cuyo header contenga "rut"
        let idx = (data[0]||[]).findIndex(h => /rut/i.test(String(h||'')));
        // 2) Si no hay, intenta por contenido
        if (idx<0){
          const sample = data[1] || [];
          for (let c=0;c<sample.length;c++){
            if (/[0-9Kk\.\-]{7,12}/.test(String(sample[c]||''))){ idx=c; break; }
          }
        }
        if (idx<0) idx=0;
        return idx;
      },
      '_rutClean': s => String(s||'').toUpperCase().replace(/[^0-9K]/g,''),
      '_rutDV': body =>{
        let sum=0, mul=2;
        for (let i=body.length-1;i>=0;i--){ sum += mul*(+body[i]); mul = (mul===7)?2:(mul+1); }
        const res = 11 - (sum % 11);
        return res===11?'0' : (res===10?'K': String(res));
      },
      '_rutFormat': (body,dv)=> body.replace(/\B(?=(\d{3})+(?!\d))/g,'.')+'-'+dv,

      'rut-normalize': ()=>{
        const idx = actions._rutColIndex();
        data = data.map((row,i)=>{
          if (i===0) return row;
          const raw = String(row[idx]||'').trim(); if (!raw) return row;
          const clean = actions._rutClean(raw); if (clean.length<2) return row;
          const body = clean.slice(0,-1), dv = clean.slice(-1);
          const ok = actions._rutDV(body) === dv;
          const formatted = actions._rutFormat(body,dv);
          const copy = row.slice();
          copy[idx] = ok ? formatted : formatted+' ⚠️';
          return copy;
        });
        render();
      },

      'rut-validate': ()=>{
        if (!data.length) return;
        const idx = actions._rutColIndex();
        let headers = data[0].slice();
        let colVal = headers.findIndex(h => /RUT_Válido/i.test(String(h||'')));
        if (colVal<0){ colVal = headers.length; headers.push('RUT_Válido'); }
        const out = [headers];
        for (let i=1;i<data.length;i++){
          const r = data[i].slice();
          const clean = actions._rutClean(r[idx]);
          let ok=false;
          if (clean.length>=2){
            const body = clean.slice(0,-1), dv = clean.slice(-1);
            ok = actions._rutDV(body) === dv;
          }
          r[colVal] = ok ? 'Sí':'No';
          out.push(r);
        }
        data = out; render();
      },

      'rut-duplicates': ()=>{
        if (!data.length) return;
        const idx = actions._rutColIndex();
        let headers = data[0].slice();
        let col = headers.findIndex(h => /RUT_Duplicado/i.test(String(h||'')));
        if (col<0){ col = headers.length; headers.push('RUT_Duplicado'); }
        const counts = new Map();
        data.slice(1).forEach(r=>{
          const key = actions._rutClean(r[idx]||'');
          if(!key) return; counts.set(key,(counts.get(key)||0)+1);
        });
        const out=[headers];
        data.slice(1).forEach(row=>{
          const r = row.slice();
          const key = actions._rutClean(r[idx]||'');
          r[col] = (key && counts.get(key)>1) ? 'Sí':'No';
          out.push(r);
        });
        data=out; render();
      },

      'rut-keep-valid': ()=>{
        if (!data.length) return;
        const idx = actions._rutColIndex();
        const out=[data[0]];
        data.slice(1).forEach(r=>{
          const c = actions._rutClean(r[idx]||'');
          if (c.length>=2){
            const body=c.slice(0,-1), dv=c.slice(-1);
            if (actions._rutDV(body)===dv) out.push(r);
          }
        });
        data=out; render();
      },

      'rut-dedupe': ()=>{
        if (!data.length) return;
        const idx = actions._rutColIndex();
        const seen=new Set(); const out=[data[0]];
        data.slice(1).forEach(r=>{
          const key = actions._rutClean(r[idx]||'');
          if (!key) return out.push(r); // deja vacíos
          if (!seen.has(key)){ seen.add(key); out.push(r); }
        });
        data=out; render();
      },

      'rut-only-dupes': ()=>{
        if (!data.length) return;
        const idx = actions._rutColIndex();
        const counts=new Map();
        data.slice(1).forEach(r=>{
          const k = actions._rutClean(r[idx]||''); if(!k) return;
          counts.set(k,(counts.get(k)||0)+1);
        });
        const out=[data[0]];
        data.slice(1).forEach(r=>{
          const k = actions._rutClean(r[idx]||'');
          if (k && counts.get(k)>1) out.push(r);
        });
        data=out; render();
      }
    };

    function forEachCell(fn){
      if (!data.length) return;
      const out = [data[0]];
      for (let i=1;i<data.length;i++){
        out.push((data[i]||[]).map(fn));
      }
      data = out; render();
    }

    function dateFix(v){
      const s = String(v??'').trim();
      const m = s.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})$/);
      if (!m){
        // ISO → queda como viene
        return s;
      }
      let a=+m[1], b=+m[2], c=+m[3];
      if (c<100) c += 2000;
      let day,mon,yr;
      if (a>12){ day=a; mon=b; yr=c; }
      else if (a<=12 && b>12){ day=b; mon=a; yr=c; }
      else { day=a; mon=b; yr=c; }
      return `${yr}-${String(mon).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    }

    // Eventos UI
    $('#btnLoad').addEventListener('click', loadFromTextarea);
    $('#btnClear').addEventListener('click', clearAll);

    document.querySelectorAll('[data-act]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const a = btn.getAttribute('data-act');
        if (actions[a]) actions[a]();
      });
    });

    // Guardar / Restaurar estado
    $('#btnSaveState').addEventListener('click',()=>{
      localStorage.setItem('dc_text', raw.value);
      localStorage.setItem('dc_data', JSON.stringify(data));
      flash(btnSaveState,'Guardado');
    });
    const btnSaveState = $('#btnSaveState');

    $('#btnRestoreState').addEventListener('click',()=>{
      const t = localStorage.getItem('dc_text');
      const d = localStorage.getItem('dc_data');
      if (t) raw.value = t;
      if (d){ try{ data = JSON.parse(d) || []; }catch(e){ data=[]; } }
      render();
      flash(btnRestoreState,'Listo');
    });
    const btnRestoreState = $('#btnRestoreState');

    function flash(el,text){
      const old = el.textContent;
      el.textContent = text+' ✓';
      setTimeout(()=> el.textContent = old, 1200);
    }

    // Export
    $('#btnCopy').addEventListener('click', async ()=>{
      if (!data.length) return;
      await navigator.clipboard.writeText(toCSV(data, ','));
      flash($('#btnCopy'),'Copiado');
    });

    $('#btnCsvOrdered').addEventListener('click', ()=>{
      if (!data.length) return;
      const headers = (data[0]||[]).map(h => String(h||'').trim().replace(/_/g,' '));
      const body = data.slice(1).filter(r => r.some(c => String(c||'').trim()!==''));
      const csv = toCSV([headers, ...body], ',');
      downloadBlob('\uFEFF'+csv, 'text/csv;charset=utf-8', 'datacleaner.csv');
    });

    $('#btnXls').addEventListener('click', ()=>{
      if (!data.length) return;
      const headers = (data[0]||[]).map(h => String(h||'').trim().replace(/_/g,' '));
      const body = data.slice(1).filter(r => r.some(c => String(c||'').trim()!==''));
      const rows = [headers, ...body];
      const htmlTable = rows.map((r,i)=>'<tr>'+r.map(c=> (i===0?'<th>':'<td>') + String(c??'').replace(/&/g,'&amp;').replace(/</g,'&lt;') + (i===0?'</th>':'</td>')).join('') + '</tr>').join('');
      const html = `
      <html xmlns:o="urn:schemas-microsoft-com:office:office"
            xmlns:x="urn:schemas-microsoft-com:office:excel"
            xmlns="http://www.w3.org/TR/REC-html40">
        <head><meta charset="utf-8"></head>
        <body><table border="1">${htmlTable}</table></body>
      </html>`;
      downloadBlob(html, 'application/vnd.ms-excel', 'datacleaner.xls');
    });

    $('#btnXlsx').addEventListener('click', ()=>{
      if (!window.XLSX || !data.length) return alert('No se encontró XLSX.');
      const headers = (data[0]||[]).map(h => String(h||'').trim().replace(/_/g,' '));
      const body = data.slice(1).filter(r => r.some(c => String(c||'').trim()!==''));
      const rows = [headers, ...body];
      const ws = XLSX.utils.aoa_to_sheet(rows, { cellDates:true });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'DataCleaner');
      // ancho
      const range = XLSX.utils.decode_range(ws['!ref']);
      ws['!cols'] = headers.map((h,c)=>{
        let maxLen = String(h).length;
        for (let r=1;r<=range.e.r;r++){
          const L = String(rows[r]?.[c] ?? '').length;
          if (L>maxLen) maxLen=L;
        }
        return { wch: Math.min(Math.max(10, maxLen+2), 48) };
      });
      ws['!freeze'] = { xSplit:0, ySplit:1 };
      ws['!autofilter'] = { ref: ws['!ref'] };
      XLSX.writeFile(wb, 'datacleaner.xlsx');
    });

    function downloadBlob(content, mime, filename){
      const blob = new Blob([content], {type:mime});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    // Drag & drop / File input
    ;['dragenter','dragover'].forEach(ev=>{
      drop.addEventListener(ev, e => { e.preventDefault(); drop.classList.add('drag'); });
    });
    ;['dragleave','drop'].forEach(ev=>{
      drop.addEventListener(ev, e => { e.preventDefault(); drop.classList.remove('drag'); });
    });
    drop.addEventListener('drop', e=>{
      const f = e.dataTransfer.files?.[0];
      if (f) readFile(f);
    });
    file.addEventListener('change', e=>{
      const f = e.target.files?.[0];
      if (f) readFile(f);
      file.value='';
    });

    function readFile(f){
      const name = f.name.toLowerCase();
      if (name.endsWith('.csv')){
        const r = new FileReader();
        r.onload = ()=> { data = parseCSV(String(r.result||'')); render(); };
        r.readAsText(f,'utf-8');
      } else if (name.endsWith('.xlsx') || name.endsWith('.xls')){
        const r = new FileReader();
        r.onload = ()=>{
          const wb = XLSX.read(r.result, {type:'binary'});
          const ws = wb.Sheets[wb.SheetNames[0]];
          const arr = XLSX.utils.sheet_to_json(ws, {header:1, defval:''});
          data = (arr||[]).filter(row => row.some(c => String(c).trim()!==''));
          delimiter = ','; // al exportar CSV
          render();
        };
        r.readAsBinaryString(f);
      } else {
        alert('Formato no soportado. Usa CSV o XLSX.');
      }
    }

    // Inicial
    $('#btnLoad').click();

    // Año
    $('#year').textContent = new Date().getFullYear();
  })();
  </script>
</body>
</html>
