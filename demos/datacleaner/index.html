<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DataCleaner · RockCode</title>
<meta name="description" content="Limpia datos CSV/Excel en segundos: duplicados, RUT, fechas, tildes y más. 100% en tu navegador." />
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%2310b981'/></svg>">
<style>
  :root{--bg:#0b1220;--ink:#e5e7eb;--muted:#94a3b8;--line:#1f2937;--accent:#22c55e;--ink-2:#cbd5e1}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0a0f1f,#0b1220);color:var(--ink);font:15px/1.45 system-ui,Segoe UI,Inter,Roboto,Ubuntu,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:24px 16px}
  h1{margin:0 0 8px;font-size:clamp(22px,3.5vw,28px)}
  .sub{color:var(--muted);margin:0 0 20px}
  .card{border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.02);padding:16px}
  .grid{display:grid;gap:16px;grid-template-columns:1fr 1fr}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  textarea{width:100%;min-height:190px;background:#0b1220;border:1px solid var(--line);border-radius:12px;color:var(--ink);padding:12px 12px 10px 12px;resize:vertical}
  .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
  .btn{appearance:none;border:1px solid var(--line);background:#0f172a;color:var(--ink);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn:hover{filter:brightness(1.05)}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .primary{background:var(--accent);color:#062b14;border-color:#16a34a}
  .ghost{background:transparent}
  .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px}
  .drop{margin-top:8px;padding:12px;text-align:center;color:var(--muted);border:2px dashed var(--line);border-radius:12px}
  .drop.over{border-color:var(--accent);background:rgba(34,197,94,.08);color:#a7f3d0}
  .tableWrap{margin-top:12px;border:1px solid var(--line);border-radius:12px;overflow:auto;max-height:min(56vh,520px)}
  table{border-collapse:collapse;width:100%;background:rgba(255,255,255,.02);font-size:13px;min-width:720px}
  th{position:sticky;top:0;background:#111827;color:#9ca3af;font-weight:600}
  td,th{border:1px solid #1f2937;padding:6px 8px;white-space:nowrap;text-align:left}
  tbody tr:nth-child(even){background:rgba(255,255,255,.03)}
  footer{color:var(--muted);font-size:13px;margin-top:18px;text-align:center}
  a{color:inherit}
</style>
</head>
<body>
  <main class="wrap">
    <h1>DataCleaner</h1>
    <p class="sub">Limpia datos en segundos: CSV/Excel, RUT, fechas, tildes y duplicados. Todo corre en tu navegador.</p>

    <section class="card">
      <div class="grid">
        <div>
          <label for="raw" class="pill" style="display:inline-block;margin-bottom:8px">Pega tus datos (CSV con coma o punto y coma)</label>
          <textarea id="raw" spellcheck="false"></textarea>
          <div class="bar">
            <button class="btn primary" id="load">Cargar</button>
            <button class="btn ghost" id="clear">Limpiar</button>
            <span class="pill" id="meta">0 filas · 0 columnas</span>

            <input id="file" type="file" accept=".csv,.txt,.tsv,.xlsx,.xls" hidden>
            <button class="btn" id="fileBtn" title="Subir archivo CSV/TXT/TSV/XLS/XLSX">Subir archivo</button>
          </div>
          <div id="drop" class="drop" aria-label="Arrastra aquí tu CSV/XLSX">Arrastra CSV/XLSX aquí</div>
        </div>

        <div>
          <label class="pill" style="display:inline-block;margin-bottom:8px">Acciones</label>
          <div class="bar" style="gap:8px">
            <button class="btn" data-act="trim">Quitar espacios</button>
            <button class="btn" data-act="collapse">Espacios múltiples → uno</button>
            <button class="btn" data-act="lower">minúsculas</button>
            <button class="btn" data-act="upper">MAYÚSCULAS</button>
            <button class="btn" data-act="title">Título</button>
            <button class="btn" data-act="dedupe">Eliminar duplicados</button>
            <button class="btn" data-act="drop-empty">Eliminar filas vacías</button>
            <button class="btn" data-act="normalize">Quitar acentos</button>
            <button class="btn" data-act="date">Normalizar fecha</button>
            <button class="btn" data-act="rut-normalize">Normalizar RUT</button>
            <button class="btn" data-act="rut-validate">Validar RUT</button>
            <button class="btn" data-act="rut-duplicates">Etiquetar duplicados RUT</button>
            <button class="btn primary" id="quickPipeline" title="Limpieza completa en 1 clic">Pipeline rápida</button>
          </div>
        </div>
      </div>

      <div class="tableWrap"><table id="table"></table></div>

      <div class="bar" style="justify-content:flex-start;margin-top:12px">
        <button class="btn" id="copyCsv">Copiar CSV</button>
        <button class="btn" id="downloadCsv">Descargar CSV (ordenado)</button>
        <button class="btn primary" id="downloadXls">Descargar Excel (XLS)</button>
        <button class="btn" id="downloadXlsx">Descargar Excel (XLSX)</button>
      </div>
    </section>

    <footer>© <span id="y"></span> RockCode — DataCleaner. Diseño & desarrollo: <strong>Rockwell Harrison</strong> + <strong>Spark (ChatGPT)</strong></footer>
  </main>

  <!-- XLSX opcional: coloca xlsx.full.min.js en esta carpeta para habilitar import/export XLSX -->
  <script src="xlsx.full.min.js" onerror="/* opcional */"></script>
  <script>
  (function(){
    const $ = id => document.getElementById(id);

    // ========= Persistencia =========
    const LS_KEY_ROWS = 'rockcode_datacleaner_rows_v1';
    const LS_KEY_RAW  = 'rockcode_datacleaner_raw_v1';

    function saveState() {
      try {
        if (data && data.length) localStorage.setItem(LS_KEY_ROWS, JSON.stringify(data));
        localStorage.setItem(LS_KEY_RAW, $('raw')?.value ?? '');
      } catch(_) {}
    }
    function loadState() {
      try {
        const raw = localStorage.getItem(LS_KEY_RAW);
        if (raw && $('raw')) $('raw').value = raw;
        const rows = JSON.parse(localStorage.getItem(LS_KEY_ROWS) || '[]');
        if (Array.isArray(rows) && rows.length) { data = rows; render(); return true; }
      } catch(_) {}
      return false;
    }

    // ========= Estado =========
    let data = []; // AOA
    const table = $('table'), meta = $('meta');

    // ========= Utilidades =========
    async function copyTextSafe(text){
      try{ await navigator.clipboard.writeText(text); }
      catch(e){
        const ta=document.createElement('textarea');
        ta.value=text; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); ta.remove();
      }
    }

    function detectSep(sample){
      const s = sample.slice(0, 2000);
      const sc = (s.match(/;/g)||[]).length, cc = (s.match(/,/g)||[]).length;
      return sc > cc ? ';' : ',';
    }
    function parseCSV(text){
      if (!text) return [];
      const norm = String(text).replace(/\r\n/g,'\n').replace(/\r/g,'\n');
      if (!norm.trim()) return [];
      const sep = detectSep(norm);
      const lines = norm.split('\n');
      const rows = [];
      for (let line of lines){
        if (line === '') { rows.push(['']); continue; } // preserva filas vacías explícitas
        const row=[], n=line.length;
        let cur='', inQ=false;
        for (let i=0;i<n;i++){
          const ch=line[i], nx=line[i+1];
          if (ch === '"' && nx === '"'){ cur+='"'; i++; continue; }
          if (ch === '"'){ inQ=!inQ; continue; }
          if (ch === sep && !inQ){ row.push(cur); cur=''; continue; }
          cur += ch;
        }
        row.push(cur);
        rows.push(row.map(c => String(c)));
      }
      return rows.filter(r => r.some(c => String(c).trim() !== ''));
    }
    function toCSV(rows, sep=','){
      return rows.map(r => r.map(c=>{
        const s=String(c??'');
        return /["\n,;\t]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
      }).join(sep)).join('\n');
    }
    function render(){
      table.innerHTML='';
      if (!data.length){ meta.textContent='0 filas · 0 columnas'; saveState(); return; }
      const cols = Math.max(...data.map(r=>r.length));
      let thead='<thead><tr>';
      for (let i=0;i<cols;i++) thead+=`<th>${data[0][i] || ('Col '+(i+1))}</th>`;
      thead+='</tr></thead>';
      let body='<tbody>';
      for (let r=1;r<data.length;r++){
        body+='<tr>';
        for (let c=0;c<cols;c++) body+=`<td>${(data[r][c]??'')}</td>`;
        body+='</tr>';
      }
      body+='</tbody>';
      table.innerHTML = thead + body;
      meta.textContent = `${data.length-1} filas · ${cols} columnas`;
      saveState();
    }

    // ===== Acciones =====
    const actions = {
      trim(){ for (let r=1;r<data.length;r++) data[r]=data[r].map(c=>String(c??'').trim()); },
      collapse(){ for (let r=1;r<data.length;r++) data[r]=data[r].map(c=>String(c??'').replace(/\s+/g,' ').trim()); },
      lower(){ for (let r=1;r<data.length;r++) data[r]=data[r].map(c=>String(c??'').toLowerCase()); },
      upper(){ for (let r=1;r<data.length;r++) data[r]=data[r].map(c=>String(c??'').toUpperCase()); },
      title(){
        const tt=s=> s.toLowerCase().replace(/\b([\p{L}\p{M}][\p{L}\p{M}'-]*)/gu,m=>m.charAt(0).toUpperCase()+m.slice(1));
        for (let r=1;r<data.length;r++) data[r]=data[r].map(c=>tt(String(c??'')));
      },
      dedupe(){
        const seen=new Set(), out=[data[0]];
        for (let r=1;r<data.length;r++){ const k=JSON.stringify(data[r]); if(!seen.has(k)){ seen.add(k); out.push(data[r]); } }
        data=out;
      },
      'drop-empty'(){ data=[data[0], ...data.slice(1).filter(r => r.some(c => String(c||'').trim() !== ''))]; },
      normalize(){ for (let r=1;r<data.length;r++) data[r]=data[r].map(c=> String(c??'').normalize('NFD').replace(/[\u0300-\u036f]/g,'')); },
      date(){
        const fix=v=>{
          const s=String(v??'').trim();
          // dd/mm/yy(yy) o dd-mm-yy(yy)
          let m=s.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})$/);
          if(m){
            let a=+m[1], b=+m[2], c=+m[3]; if(c<100) c+=2000;
            let day,mon,yr;
            if (a>12){ day=a; mon=b; yr=c; }
            else if (a<=12 && b>12){ day=b; mon=a; yr=c; }
            else { day=a; mon=b; yr=c; }
            return `${yr}-${String(mon).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
          }
          // yyyy-mm-dd
          m=s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
          if(m){ const Y=+m[1], M=+m[2], d=+m[3]; return `${Y}-${String(M).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
          // mm/dd/yyyy → ISO (asume US)
          m=s.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
          if(m && (+m[1] <= 12 && +m[2] <= 31)){ const M=+m[1], d=+m[2], Y=+m[3]; return `${Y}-${String(M).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
          return v;
        };
        for (let r=1;r<data.length;r++) data[r]=data[r].map(fix);
      },

      // --- RUT helpers ---
      _rut_detect(headers, sample){
        let idx = headers.findIndex(h => /rut/i.test(String(h||'')));
        if (idx<0 && sample){
          for (let c=0;c<sample.length;c++){ const v=String(sample[c]||''); if(/[0-9Kk\.\-]{7,12}/.test(v)){ idx=c; break; } }
        }
        return idx<0 ? 0 : idx;
      },
      _rut_clean(s){ return String(s||'').toUpperCase().replace(/[^0-9K]/g,''); },
      _rut_calcDV(body){
        let sum=0, mul=2; for (let i=body.length-1;i>=0;i--){ sum+=mul*(+body[i]); mul = (mul===7)?2:(mul+1); }
        const res=11-(sum%11); return res===11?'0': (res===10?'K': String(res));
      },
      _rut_format(body,dv){ return body.replace(/\B(?=(\d{3})+(?!\d))/g,'.')+'-'+dv; },

      'rut-normalize'(){
        if(!data.length) return;
        const idx=this._rut_detect(data[0], data[1]);
        const out=data.map((row,i)=>{
          if(i===0) return row;
          const raw=String(row[idx]||'').trim(); if(!raw) return row;
          const cleaned=this._rut_clean(raw); if (cleaned.length<2) return row;
          const body=cleaned.slice(0,-1), dv=cleaned.slice(-1);
          const ok=this._rut_calcDV(body)===dv;
          const formatted=this._rut_format(body,dv);
          const copy=row.slice(); copy[idx]= ok? formatted : (formatted+' ⚠️'); return copy;
        });
        data=out;
      },

      'rut-validate'(){
        if(!data.length) return;
        const headers=data[0].slice();
        let col=headers.findIndex(h => /RUT_Valido/i.test(String(h||'')));
        if (col<0){ col=headers.length; headers.push('RUT_Valido'); }
        const idx=this._rut_detect(data[0], data[1]);
        const out=[headers].concat(data.slice(1).map(row=>{
          const r=row.slice();
          const cleaned=this._rut_clean(r[idx]); let ok=false;
          if (cleaned.length>=2){
            const body=cleaned.slice(0,-1), dv=cleaned.slice(-1);
            ok = this._rut_calcDV(body)===dv;
          }
          r[col]= ok? 'Sí':'No'; return r;
        }));
        data=out;
      },

      'rut-duplicates'(){
        if(!data.length) return;
        const headers=data[0].slice();
        let col=headers.findIndex(h => /RUT_Duplicado/i.test(String(h||'')));
        if (col<0){ col=headers.length; headers.push('RUT_Duplicado'); }
        const idx=this._rut_detect(data[0], data[1]);
        const counts=new Map();
        data.slice(1).forEach(r=>{ const k=this._rut_clean(r[idx]||''); if(!k) return; counts.set(k,(counts.get(k)||0)+1); });
        const out=[headers].concat(data.slice(1).map(row=>{
          const r=row.slice(); const key=this._rut_clean(r[idx]||'');
          r[col]= key && counts.get(key)>1 ? 'Sí' : 'No'; return r;
        }));
        data=out;
      }
    };

    // ===== Pipeline rápida =====
    $('quickPipeline').addEventListener('click', () => {
      if (!data.length) return;
      actions.trim();
      actions.collapse();
      actions['drop-empty']();
      actions.normalize();
      actions.date();
      actions['rut-normalize']();
      render();
    });

    // ===== Cargar desde textarea / archivo =====
    function loadRowsFromText(text){
      const rows = parseCSV(text);
      if (!rows.length){ data=[]; render(); return; }
      const head = rows[0] || [];
      const scoreLetters = head.filter(x => /[A-Za-zÁÉÍÓÚÜÑáéíóúüñ]/.test(String(x||''))).length;
      data = scoreLetters ? rows
                          : [['Col 1','Col 2','Col 3','Col 4','Col 5'].slice(0,(rows[0]||[]).length), ...rows];
      render();
    }
    async function handleFile(file){
      const name=(file.name||'').toLowerCase();
      try{
        if (/\.(csv|txt|tsv)$/.test(name)){
          const text = await file.text();
          loadRowsFromText(text);
        } else if (/\.(xlsx|xls)$/.test(name)){
          if (!window.XLSX){ alert('Para XLS/XLSX coloca xlsx.full.min.js junto a este archivo.'); return; }
          const buf = await file.arrayBuffer();
          const wb  = XLSX.read(buf, { type:'array' });
          const ws  = wb.Sheets[wb.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(ws, { header:1, raw:false, defval:'' });
          data = rows && rows.length ? rows : [];
          render();
        } else {
          alert('Formato no soportado. Usa CSV/TXT/TSV o XLS/XLSX.');
        }
      }catch(e){
        console.error(e);
        alert('No se pudo leer el archivo. Revisa el formato/codificación.');
      }
    }

    // ===== Eventos UI =====
    $('load').addEventListener('click', ()=> loadRowsFromText($('raw').value));
    $('clear').addEventListener('click', ()=>{ $('raw').value=''; data=[]; render(); });
    document.querySelectorAll('[data-act]').forEach(b=>{
      b.addEventListener('click', ()=>{ const act=b.getAttribute('data-act'); if (actions[act]){ actions[act](); render(); } });
    });

    $('copyCsv').addEventListener('click', async ()=>{
      if (!data.length) return;
      const headers = (data[0]||[]).map(h => String(h||'').trim().replace(/_/g,' '));
      const body = data.slice(1).filter(r => r.some(c => String(c||'').trim() !== ''));
      await copyTextSafe(toCSV([headers, ...body]));
    });

    $('downloadCsv').addEventListener('click', ()=>{
      if (!data.length) return;
      const headers = (data[0]||[]).map(h => String(h||'').trim().replace(/_/g,' '));
      const body = data.slice(1).filter(r => r.some(c => String(c||'').trim() !== ''));
      const csv = toCSV([headers, ...body]);
      const blob = new Blob(['\ufeff'+csv], {type:'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='rockcode_datacleaner.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    $('downloadXls').addEventListener('click', ()=>{
      if (!data.length) return;
      const headers = (data[0]||[]).map(h => String(h||'').trim().replace(/_/g,' '));
      const body = data.slice(1).filter(r => r.some(c => String(c||'').trim() !== ''));
      const rows = [headers, ...body];
      const htmlTable = rows.map((r,i)=>'<tr>'+r.map(c=> (i===0?'<th>':'<td>') + String(c??'').replace(/&/g,'&amp;').replace(/</g,'&lt;') + (i===0?'</th>':'</td>')).join('') + '</tr>').join('');
      const html = `
      <html xmlns:o="urn:schemas-microsoft-com:office:office"
            xmlns:x="urn:schemas-microsoft-com:office:excel"
            xmlns="http://www.w3.org/TR/REC-html40">
      <head><meta charset="utf-8"><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet>
      <x:Name>DataCleaner</x:Name><x:WorksheetOptions><x:Print/></x:WorksheetOptions></x:ExcelWorksheet>
      </x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head>
      <body><table border="1">${htmlTable}</table></body></html>`;
      const blob = new Blob([html], {type:'application/vnd.ms-excel'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='rockcode_datacleaner.xls'; a.click();
      URL.revokeObjectURL(url);
    });

    $('downloadXlsx').addEventListener('click', ()=>{
      if (!window.XLSX){ alert('Para XLSX nativo, coloca xlsx.full.min.js junto a este archivo.'); return; }
      if (!data.length) return;
      const headersRaw = data[0] || [];
      const headers = headersRaw.map(h => String(h||'').trim().replace(/_/g,' '));
      const body = data.slice(1).filter(r => r.some(c => String(c||'').trim() !== ''));
      const toISO = v => /^\d{4}-\d{2}-\d{2}$/.test(String(v||''));
      const isNumericHeader = name =>
        /(edad|monto|total|tiempo|id|cantidad|nro|número|precio|anio|año)/i.test(name||'') &&
        !/rut/i.test(name||'');
      const rows = [headers, ...body.map(row => row.map((v,i) => {
        const s = String(v ?? '').trim();
        if (toISO(s)) return new Date(s + 'T00:00:00');
        if (isNumericHeader(headers[i])) {
          const n = Number(s.replace(/\./g,'').replace(',', '.'));
          if (!Number.isNaN(n) && isFinite(n)) return n;
        }
        return v;
      }))];
      const ws = XLSX.utils.aoa_to_sheet(rows, { cellDates:true });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'DataCleaner');
      const range = XLSX.utils.decode_range(ws['!ref']);
      ws['!cols'] = headers.map((h,c)=>{
        let max=String(h).length;
        for (let r=1;r<=range.e.r;r++){ const L=String(rows[r]?.[c] ?? '').length; if (L>max) max=L; }
        return { wch: Math.min(Math.max(10, max+2), 48) };
      });
      ws['!freeze'] = { xSplit:0, ySplit:1 };
      ws['!autofilter'] = { ref: ws['!ref'] };
      XLSX.writeFile(wb, 'rockcode_datacleaner.xlsx');
    });

    // Subir archivo
    $('fileBtn').addEventListener('click', ()=> $('file').click());
    $('file').addEventListener('change', e=>{
      const f=e.target.files && e.target.files[0]; if (f) handleFile(f); e.target.value='';
    });

    // Drag & drop
    const drop=$('drop');
    ['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); drop.classList.add('over'); }));
    ['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); drop.classList.remove('over'); }));
    drop.addEventListener('drop', e=>{
      const f=e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
      if (f) handleFile(f);
    });

    // ===== Arranque: recuperar estado o seed =====
    const had = loadState();
    if (!had) {
      $('raw').value = `nombre,correo,rut,fecha,ciudad
ANA, ana@example.com, 12345678-5, 1/2/24, ViÑA del Mar
Ana, ana@example.com, 12.345.678-5, 01-02-2024, viña  del   mar
Pedro, pedro@example.com, 11111111-1, 12/31/2023, santiago
 , , , , 
JUAN, juan@example.com, 9876543k, 5-7-2024, PROVIDENCIA`;
      // Render inicial vacío (muestra 0 filas hasta que cargues)
      render();
    }

    // Año footer
    document.getElementById('y').textContent = new Date().getFullYear();
  })();
  </script>
</body>
</html>
